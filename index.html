<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>B1ux ç¾å·¥ä¹‹æ—… Promax</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #54a3ff;
      --primary-soft: #e7f2ff;
      --primary-deep: #2d7fe8;
      --bg-body: #f5f7fb;
      --bg-card: #ffffff;
      --text-main: #1f2933;
      --text-sub: #6b7280;
      --radius-lg: 16px;
      --shadow-soft: 0 10px 24px rgba(26,115,232,.12);
      --border-soft: 1px solid #e2e8f0;
      --success: #16a34a;
      --success-bg: #e8faf0;
      --danger: #ef4444;
      --danger-bg: #fee2e2;
      --warn: #f59e0b;
      --warn-bg: #fef3c7;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
      background:radial-gradient(circle at top,#e3f0ff 0,#f5f7fb 40%,#f5f7fb 100%);
      color:var(--text-main);
    }
    .page{
      max-width:1100px;
      margin:32px auto 64px;
      padding:0 16px;
    }
    header.app-header{
      border-radius:24px;
      padding:18px 20px;
      background:linear-gradient(135deg,#74b9ff 0%,#a29bfe 45%,#6c5ce7 100%);
      color:#fff;
      box-shadow:0 18px 45px rgba(88,143,255,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .header-left h1{
      margin:0;
      font-size:22px;
      white-space:nowrap;
    }
    .header-sub{
      font-size:12px;
      opacity:.9;
      margin-top:4px;
    }
    .header-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .btn,.btn-outline,.btn-danger,.btn-edit,.btn-secondary{
      border-radius:999px;
      border:none;
      font-size:13px;
      padding:6px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
      transition:.12s;
      font-weight:500;
    }
    .btn{background:#fff;color:var(--primary-deep);box-shadow:0 6px 18px rgba(15,23,42,.16);}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(15,23,42,.18);}
    
    /* å¤§éƒ¨åˆ†èƒŒæ™¯æ˜¯ç™½è‰²çš„ï¼Œæ‰€ä»¥ outline æŒ‰é’®æ”¹æˆæ·±è‰²æ–‡å­—æˆ–è€…æµ…è“èƒŒæ™¯ */
    .btn-outline{
      background:transparent;
      color:#fff; /* ä»…åœ¨æ·±è‰²èƒŒæ™¯(Header)ä½¿ç”¨ */
      border:1px solid rgba(255,255,255,.75);
    }
    .btn-outline:hover{background:rgba(255,255,255,.18);}
    
    /* æ–°å¢ï¼šç”¨äºç™½è‰²å¡ç‰‡ä¸Šçš„æ¬¡çº§æŒ‰é’® */
    .btn-secondary {
      background: var(--primary-soft);
      color: var(--primary-deep);
    }
    .btn-secondary:hover {
      background: #dbeafe;
    }

    .btn-sm{padding:4px 10px;font-size:12px;box-shadow:none;}
    .btn-danger{background:var(--danger-bg);color:var(--danger);}
    .btn-edit{background:var(--warn-bg);color:var(--warn);}
    
    main.main{margin-top:20px;}
    .stats-row{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
    }
    .stat-card{
      background:#fff;
      border-radius:18px;
      padding:10px 12px;
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }
    .stat-label{
      font-size:12px;
      color:var(--text-sub);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .stat-tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#eef2ff;
      color:#4338ca;
    }
    .stat-value{
      margin-top:6px;
      font-size:20px;
      font-weight:700;
      color:var(--primary-deep);
    }
    .stat-sub{
      font-size:12px;
      color:var(--text-sub);
      margin-top:2px;
    }
    .tabs{
      margin-top:22px;
      display:flex;
      gap:8px;
      overflow-x:auto;
      padding-bottom:4px;
    }
    .tabs::-webkit-scrollbar{height:4px;}
    .tabs::-webkit-scrollbar-thumb{background:#d0ddf5;border-radius:999px;}
    .tab-btn{
      border-radius:999px;
      border:1px solid transparent;
      background:rgba(255,255,255,.9);
      padding:6px 12px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--text-sub);
      box-shadow:0 4px 14px rgba(15,23,42,.08);
      flex-shrink:0;
    }
    .tab-btn.active{
      background:#fff;
      color:var(--primary-deep);
      border-color:rgba(84,163,255,.7);
      box-shadow:0 8px 20px rgba(84,163,255,.2);
    }
    .tab-panel{display:none;margin-top:14px;}
    .tab-panel.active{display:block;}
    .card{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 14px;
      margin-bottom:18px;
    }
    .section-title{
      margin:0 0 10px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .section-title::before{
      content:"";
      width:4px;
      height:18px;
      border-radius:999px;
      background:var(--primary);
    }
    .section-title span.sub{
      font-size:12px;
      color:var(--text-sub);
      font-weight:400;
    }
    .grid-two{
      display:grid;
      grid-template-columns:minmax(0,7fr) minmax(0,5fr);
      gap:14px;
    }
    .field-row{
      display:flex;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .field{
      flex:1 1 0;
      min-width:130px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{font-size:12px;color:var(--text-sub);}
    input[type=text],input[type=number],input[type=date],input[type=month],textarea,select{
      border-radius:10px;
      border:1px solid #d1d9e6;
      padding:6px 8px;
      font-size:13px;
      outline:none;
      background:#fbfcff;
      transition:.12s;
    }
    input:focus,textarea:focus,select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(84,163,255,.25);
      background:#fff;
    }
    textarea{resize:vertical;min-height:60px;}
    .pill-switch{
      display:inline-flex;
      border-radius:999px;
      background:#edf2ff;
      padding:2px;
    }
    .pill-switch button{
      border-radius:999px;
      border:none;
      padding:4px 10px;
      font-size:12px;
      background:transparent;
      color:var(--text-sub);
      cursor:pointer;
    }
    .pill-switch button.active{
      background:#fff;
      color:var(--primary-deep);
      box-shadow:0 2px 8px rgba(15,23,42,.15);
    }
    .edit-bar{
      display:none;
      margin-bottom:10px;
      border-radius:12px;
      background:var(--warn-bg);
      padding:6px 10px;
      font-size:12px;
      color:#92400e;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .edit-bar.show{display:flex;}
    .set-rows{
      border-radius:10px;
      border:var(--border-soft);
      padding:6px;
      background:#f9fbff;
      max-height:210px;
      overflow-y:auto;
    }
    .row-group{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff;
      border-radius:999px;
      padding:3px 8px;
      margin:3px 4px 3px 0;
      box-shadow:0 1px 5px rgba(15,23,42,.12);
      cursor:grab;
    }
    .row-group input,.row-group select{width:110px;}
    .row-group .drag{font-size:13px;color:#9ca3af;}
    .row-group .del{
      border:none;
      border-radius:999px;
      padding:0 6px;
      font-size:12px;
      background:#fee2e2;
      color:#b91c1c;
      cursor:pointer;
    }
    /* å•å“æ¨¡å¼ä¸‹éšè—åˆ é™¤æŒ‰é’® */
    .row-group.single-mode .del {
      display: none;
    }

    .upload-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(60px,1fr));
      gap:6px;
      margin-top:6px;
    }
    .img-box{
      position:relative;
      border-radius:10px;
      overflow:hidden;
      background:#e5edf9;
      cursor:grab;
    }
    .img-box img{
      width:100%;
      height:60px;
      object-fit:cover;
      display:block;
    }
    .img-box span.idx{
      position:absolute;
      left:4px;
      top:3px;
      font-size:11px;
      background:rgba(15,23,42,.6);
      color:#fff;
      padding:1px 4px;
      border-radius:999px;
    }
    .img-box button.rm{
      position:absolute;
      right:4px;
      top:3px;
      border:none;
      border-radius:999px;
      padding:0 4px;
      font-size:11px;
      background:rgba(0,0,0,.55);
      color:#fff;
      cursor:pointer;
    }
    .calendar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:4px;
    }
    .cal-cell-head{
      font-size:11px;
      text-align:center;
      color:var(--text-sub);
      padding-bottom:4px;
    }
    .cal-cell{
      background:#fff;
      border-radius:12px;
      min-height:72px;
      padding:4px 4px 3px;
      display:flex;
      flex-direction:column;
      gap:3px;
      box-shadow:0 1px 4px rgba(148,163,184,.35);
    }
    .cal-cell.other-month{background:#f3f4f8;opacity:.7;}
    .cal-day-num{
      font-size:20px;
      font-weight:800;
      text-align:center;
      color:#cbd2e8;
    }
    .cal-cell.today{
      box-shadow:0 0 0 2px rgba(84,163,255,.7);
      background:#eef3ff;
    }
    .cal-cell.today .cal-day-num{color:#111827;}
    .cal-event{
      border-radius:999px;
      padding:1px 6px;
      font-size:11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      cursor:pointer;
    }
    .cal-event.done{background:var(--success-bg);color:var(--success);}
    .cal-event.pending{background:var(--danger-bg);color:var(--danger);}
    .todo-list{
      margin-top:10px;
      border-radius:12px;
      border:var(--border-soft);
      padding:8px;
      background:#f9fafb;
      max-height:220px;
      overflow-y:auto;
      font-size:12px;
    }
    .todo-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:4px 2px;
      border-bottom:1px dashed #e5e7eb;
      cursor:pointer;
    }
    .todo-item:last-child{border-bottom:none;}
    .gallery-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .card-item {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, .14);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s; /* å¢åŠ  opacity è¿‡æ¸¡ */
    }
    /* æ–°å¢ï¼šæ‹–æ‹½æ—¶çš„æ ·å¼ */
    .card-item.dragging {
      opacity: 0.4;
      border: 2px dashed var(--primary);
    }
    .card-item:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(15,23,42,.18);}
    
    /* === è¯·å®Œå…¨æ›¿æ¢ä»¥ä¸‹ CSS (ç»ˆæå¼ºåˆ¶ç‰ˆ) === */

    /* 1. ã€åˆ—è¡¨é¡µã€‘å¤§å°é¢å®¹å™¨ï¼šå®šæ­»æ­£æ–¹å½¢ */
    .card-img {
      width: 100%;
      aspect-ratio: 1 / 1;     /* å¼ºåˆ¶å®½é«˜æ¯” 1:1 */
      background: #e5edf9;
      position: relative;      /* ä½œä¸ºå®šä½åŸºå‡† */
      overflow: hidden;        /* è£æ‰è¶…å‡ºçš„éƒ¨åˆ† */
      /* æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† display: flexï¼Œé¿å…å¹²æ‰°å†…éƒ¨çš„ç»å¯¹å®šä½ */
    }

    /* 2. ã€åˆ—è¡¨é¡µã€‘å•å¼ æ™®é€šå›¾ç‰‡ */
    .card-img > img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      display: block;
    }

    /* 3. ã€åˆ—è¡¨é¡µã€‘æ‹¼å›¾ç½‘æ ¼å®¹å™¨ï¼šä½¿ç”¨ç»å¯¹å®šä½å¼ºåˆ¶æ’‘æ»¡ */
    .cover-grid {
      display: grid;
      position: absolute;      /* æ ¸å¿ƒä¿®æ”¹ï¼šè„±ç¦»æ–‡æ¡£æµï¼Œå¼ºåˆ¶å¡«æ»¡çˆ¶å®¹å™¨ */
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      gap: 2px;
      background: #fff;
    }

    /* å››å®«æ ¼ */
    .cover-grid.g-4 {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    /* ä¹å®«æ ¼ */
    .cover-grid.g-9 {
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
    }

    /* 4. ã€åˆ—è¡¨é¡µã€‘æ‹¼å›¾å°å›¾ç‰‡ï¼šå¼ºåˆ¶å¡«æ»¡æ ¼å­ */
    .cover-grid img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;    /* å¿…é¡»è£åˆ‡ */
      object-position: center !important;
      display: block;
      min-height: 0;                   /* ä¿®å¤éƒ¨åˆ†æµè§ˆå™¨ Grid é«˜åº¦æº¢å‡º bug */
    }
    
    /* 5. ã€åˆ—è¡¨é¡µã€‘æ— é¢„è§ˆæ–‡å­—æç¤º (å‚ç›´å±…ä¸­) */
    .card-img-empty {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-sub);
    }

    /* 6. ã€è¯¦æƒ…é¡µã€‘è¯¦æƒ…å›¾å®¹å™¨ (ä¿æŒåŸæ ·ï¼Œä¸è£åˆ‡) */
    .detail-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 6px;
    }

    .detail-images img {
      width: 100%;
      height: auto;
      aspect-ratio: auto;
      object-fit: contain;
      border-radius: 10px;
      display: block;
    }

    .card-body{
      padding:6px 8px 8px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1; /* æ ‡é¢˜å æ®å‰©ä½™ç©ºé—´ */
    }
    /* æ–°å¢ï¼šå¡ç‰‡æ–‡å­—åŒºåŸŸçš„å¤´éƒ¨è¡Œï¼Œç”¨äºå·¦å³æ’åˆ— æ ‡é¢˜ å’Œ å›¾æ ‡ */
    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2px;
    }
    .card-sub{
      font-size:12px;
      color:var(--text-sub);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pin-btn {
      /* åŸæ¥çš„ position: absolute; removeæ‰ */
      border: none;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #f1f5f9; /* å¹³æ—¶æ˜¯æµ…ç°è‰² */
      color: var(--text-sub);
      cursor: pointer;
      flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
      margin-left: 8px;
    }
    /* æ¿€æ´»çŠ¶æ€ï¼šè“è‰² */
    .pin-btn.pinned {
      background: var(--primary-soft);
      color: var(--primary-deep);
      font-weight: bold;
    }
    .empty-tip{font-size:13px;color:var(--text-sub);margin-top:6px;}
    .clients-grid{
      display:grid;
      grid-template-columns:minmax(0,5fr) minmax(0,7fr);
      gap:14px;
    }
    .non-client-list{
      border-radius:12px;
      border:var(--border-soft);
      padding:6px 8px;
      background:#f9fafb;
      max-height:230px;
      overflow-y:auto;
      font-size:13px;
    }
    .non-client-item{
      padding:4px 2px;
      border-bottom:1px dashed #e5e7eb;
      cursor:pointer;
    }
    .non-client-item:last-child{border-bottom:none;}
    .client-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .client-table th,.client-table td{
      padding:5px 4px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    .client-table th{font-size:12px;color:var(--text-sub);}
    .client-table tbody tr:hover{background:#eef2ff;}
    .rank-item{padding:6px 2px 8px;}
    .rank-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
    }
    .rank-name{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .rank-medal{font-size:15px;}
    .rank-bar-bg{
      margin-top:4px;
      width:100%;
      height:6px;
      border-radius:999px;
      background:#e5edff;
      overflow:hidden;
    }
    .rank-bar{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#54a3ff,#6c5ce7);
      width:0%;
    }
    .mat-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:10px;
      margin-top:6px;
    }
    .modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal.show{display:flex;}
    .modal-card{
      background:#fff;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.55);
      max-width:840px;
      width:94%;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 14px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-header h3{margin:0;font-size:16px;}
    .modal-close{
      border:none;
      border-radius:999px;
      width:26px;
      height:26px;
      background:#e5e7eb;
      cursor:pointer;
    }
    .modal-body{
      padding:10px 14px 14px;
      overflow-y:auto;
      font-size:13px;
    }
    .detail-layout{
      display:grid;
      grid-template-columns:minmax(0,6fr) minmax(0,5fr);
      gap:12px;
    }
    .detail-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:#eef2ff;
      color:#4338ca;
    }
    .badge.success{background:var(--success-bg);color:var(--success);}
    .badge.danger{background:var(--danger-bg);color:var(--danger);}
    .badge.warn{background:var(--warn-bg);color:var(--warn);}
    .detail-rem{
      margin-top:6px;
      background:var(--warn-bg);
      border-radius:10px;
      padding:6px 8px;
      color:#92400e;
      font-size:12px;
    }
    .modal-footer{
      padding:8px 14px 10px;
      border-top:1px solid #e5e7eb;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .price-table{font-size:13px;margin-top:4px;}
    .price-row{
      display:flex;
      gap:6px;
      align-items:center;
      margin-bottom:4px;
    }
    .price-row input,.price-row select{
      border-radius:8px;
      border:1px solid #d1d9e6;
      padding:4px 6px;
      font-size:13px;
    }
    .backup-row{
      font-size:12px;
      color:var(--text-sub);
      margin-top:4px;
    }
    @media(max-width:840px){
      .grid-two,.clients-grid,.detail-layout{grid-template-columns:1fr;}
      .stats-row{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:640px){
      .stats-row{grid-template-columns:1fr;}
      header.app-header{flex-direction:column;align-items:flex-start;}
      .header-actions{justify-content:flex-start;}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="app-header">
      <div class="header-left">
        <h1>B1ux çš„ç¾å·¥ä¹‹æ—…</h1>
        <div class="header-sub">2025.6 è‡³ä»Š</div>
      </div>
      <div class="header-actions">
        <button class="btn-outline btn-sm" id="btnPrice">âš™ï¸ ä»·æ ¼è¡¨</button>
        <button class="btn-outline btn-sm" id="btnExport">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
        <button class="btn-outline btn-sm" id="btnImport">ğŸ“‚ å¯¼å…¥å¤‡ä»½</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <main class="main">
      <section class="stats-row">
        <div class="stat-card">
          <div class="stat-label">
            <span>ç´¯è®¡ä½œå“æ”¶å…¥</span><span class="stat-tag">å·²å®šç¨¿</span>
          </div>
          <div class="stat-value" id="statIncome">Â¥0.00</div>
          <div class="stat-sub" id="statNet">å‡€æ”¶å…¥ï¼šÂ¥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">
            <span>ç´ ææ”¯å‡º</span><span class="stat-tag" style="background:#fee2e2;color:#b91c1c;">ä¹°ä¹°ä¹°</span>
          </div>
          <div class="stat-value" id="statExpense">-Â¥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">
            <span>äº¤ä»˜ä½œå“ / ç´ æåº“</span><span class="stat-tag">æ•°é‡</span>
          </div>
          <div class="stat-value" id="statCount">0 / 0</div>
        </div>
      </section>

      <nav class="tabs">
        <button class="tab-btn active" data-tab="upload">â• è®°ä¸€ç¬”</button>
        <button class="tab-btn" data-tab="calendar">ğŸ—“ï¸ å½“å‰æ’å•</button>
        <button class="tab-btn" data-tab="gallery">ğŸ¨ ä½œå“é›†</button>
        <button class="tab-btn" data-tab="feedback">ğŸ“¸ è¿”å›¾å¢™</button>
        <button class="tab-btn" data-tab="materials">ğŸ“¦ ç´ æåº“</button>
        <button class="tab-btn" data-tab="clients">ğŸ€ å®¢å¦¹ä»¬</button>
        <button class="tab-btn" data-tab="analysis">ğŸ“Š è¯¦ç»†ç»Ÿè®¡</button>
      </nav>

      <section class="tab-panel active" id="tab-upload">
        <div class="edit-bar" id="editBar">
          <span>ğŸ“ æ­£åœ¨ç¼–è¾‘æ—§è®°å½•â€¦ å†æ¬¡æäº¤å°†è¦†ç›–åŸä½œå“ã€‚</span>
          <button type="button" class="btn-outline btn-sm" id="btnCancelEdit" style="color:#92400e;border-color:#92400e;">å–æ¶ˆç¼–è¾‘</button>
        </div>
        <div class="grid-two">
          <div class="card">
            <h2 class="section-title">âœ¨ å½•å…¥ä½œå“æ”¶å…¥ <span class="sub">å•å“ / Set ç»„åˆ</span></h2>
            <form id="workForm">
              <div class="field-row">
                <div class="field">
                  <label>å±æ€§</label>
                  <input type="text" id="workAttr" placeholder="ä»Šå±¿" />
                  <div style="font-size:11px;color:var(--text-sub);">å‘½åï¼šå±æ€§ + ç©ºæ ¼ + (åˆ¶å“å / set) + è‡ªåŠ¨ç¼–å·</div>
                </div>
                <div class="field">
                  <label>å®¢æˆ·å</label>
                  <input list="clientList" type="text" id="workClient" placeholder="B1ux" />
                  <datalist id="clientList"></datalist>
                </div>
              </div>

              <div class="field-row" style="align-items:center;">
                <div class="field" style="flex:0 0 auto;">
                  <label>ä½œå“æ¨¡å¼</label>
                  <div class="pill-switch" id="typeSwitch">
                    <button type="button" data-type="single" class="active">å•å“</button>
                    <button type="button" data-type="set">Set ç»„åˆ</button>
                  </div>
                </div>
                <div class="field">
                  <label>ä½¿ç”¨æƒ</label>
                  <select id="workUsage">
                    <option value="è‡ªç”¨">è‡ªç”¨</option>
                    <option value="å•†ç”¨">å•†ç”¨</option>
                    <option value="ä¹°æ–­">ä¹°æ–­</option>
                  </select>
                </div>
                <div class="field">
                  <label>å…¬å¼€æ€§</label>
                  <select id="workVisibility">
                    <option value="å…¬å¼€">å…¬å¼€</option>
                    <option value="ä¸å…¬å¼€">ä¸å…¬å¼€</option>
                  </select>
                </div>
              </div>

              <div class="field">
                <label>åˆ¶å“æ˜ç»†</label>
                <div class="set-rows" id="setRows"></div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                  <span id="setHint" style="font-size:11px;color:var(--text-sub);">
                    å•å“ï¼šé»˜è®¤ä¸€æ¡åˆ¶å“ï¼›Setï¼šæŒ‰æˆå“é¡ºåºæ·»åŠ å„ä¸ªåˆ¶å“ã€‚
                  </span>
                  <button type="button" class="btn-edit btn-sm" id="btnAddRow" style="display:none;">+ æ·»åŠ å­åˆ¶å“</button>
                </div>
              </div>

              <div class="field-row">
                <div class="field">
                  <label>åŸä»·åˆè®¡ (Â¥)</label>
                  <input type="number" id="workRaw" step="0.01" />
                </div>
                <div class="field">
                  <label>æŠ˜æ‰£ï¼ˆ0 = æ— å¿ï¼‰</label>
                  <input type="number" id="workDiscount" min="0" max="1" step="0.01" value="1" />
                </div>
                <div class="field">
                  <label>å®æ”¶é‡‘é¢ (Â¥)</label>
                  <input type="number" id="workAmount" step="0.01" />
                </div>
              </div>

              <div class="field-row">
                <div class="field">
                  <label>å®šç¨¿æ—¥æœŸï¼ˆå®Œæˆï¼‰</label>
                  <input type="date" id="workDate" />
                </div>
                <div class="field">
                  <label>æˆªæ­¢æ—¥æœŸï¼ˆæ’å•ï¼‰</label>
                  <input type="date" id="workDue" />
                </div>
              </div>

              <div class="field">
                <label>ä½œå“å›¾ï¼ˆ0 ~ 10 å¼ ï¼‰</label>
                <button type="button" class="btn-secondary btn-sm" id="btnPickWorkImg">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                <input id="workImagesInput" type="file" accept="image/*" multiple style="display:none;" />
                <div class="upload-grid" id="workImgGrid"></div>
                <label style="font-size:11px;margin-top:2px;">
                  <input type="checkbox" id="chkOverview" /> æœ€åä¸€å¼ ä¸ºæ€»è§ˆå›¾
                </label>
              </div>

              <div class="field">
                <label>è¿”å›¾ï¼ˆ0 ~ 10 å¼ ï¼‰</label>
                <button type="button" class="btn-secondary btn-sm" id="btnPickFeedbackImg">ğŸ“¸ ä¸Šä¼ è¿”å›¾</button>
                <input id="feedbackImagesInput" type="file" accept="image/*" multiple style="display:none;" />
                <div class="upload-grid" id="feedbackImgGrid"></div>
              </div>

              <div class="field">
                <label>å¤‡æ³¨</label>
                <textarea id="workRemark"></textarea>
              </div>

              <div style="text-align:right;margin-top:8px;">
                <button type="submit" class="btn" id="btnSubmitWork">æäº¤ä½œå“æ”¶å…¥</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h2 class="section-title">ğŸ’¸ å½•å…¥ç´ ææ”¯å‡º</h2>
            <form id="matForm">
              <div class="field-row">
                <div class="field">
                  <label>ç´ æåç§°</label>
                  <input type="text" id="matName" />
                </div>
                <div class="field">
                  <label>å•†å®¶</label>
                  <input type="text" id="matMerchant" />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label>é‡‘é¢ (Â¥)</label>
                  <input type="number" id="matPrice" step="0.01" />
                </div>
                <div class="field">
                  <label>è´­ä¹°æ—¥æœŸ</label>
                  <input type="date" id="matDate" />
                </div>
              </div>
              <div class="field">
                <label>å¤‡æ³¨</label>
                <textarea id="matRemark"></textarea>
              </div>
              <div style="text-align:right;margin-top:8px;">
                <button type="submit" class="btn-danger btn-sm">è®°å½•æ”¯å‡º</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section class="tab-panel" id="tab-calendar">
        <div class="card">
          <h2 class="section-title">ğŸ—“ï¸ å½“å‰æ’å• <span class="sub">åªæœ‰æˆªæ­¢æ—¥æœŸ = æ’å•ï¼›åªæœ‰å®šç¨¿æ—¥æœŸ = å·²å®Œæˆ</span></h2>
          <div class="calendar-header">
            <div>
              <button type="button" class="btn-secondary btn-sm" id="btnPrevMonth">â¬… ä¸Šæœˆ</button>
              <button type="button" class="btn-secondary btn-sm" id="btnNextMonth">ä¸‹æœˆ â¡</button>
            </div>
            <input type="month" id="monthInput" />
          </div>
          <div class="calendar-grid" id="calendarHead"></div>
          <div class="calendar-grid" id="calendarBody"></div>
          <div class="todo-list">
            <div style="margin-bottom:4px;">ğŸ“‹ å¾…åŠæ¸…å•ï¼ˆå½“å‰æœˆä»½ï¼Œä»…æœ‰æˆªæ­¢æ—¥æœŸçš„æ’å•ï¼‰</div>
            <div id="todoList"></div>
          </div>
        </div>
      </section>

      <section class="tab-panel" id="tab-gallery">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 class="section-title">ğŸ¨ ä½œå“é›† <span class="sub">åªæ˜¾ç¤ºå·²å®šç¨¿ä½œå“</span></h2>
            <select id="selSortWorks" style="max-width:150px;">
              <option value="custom">è‡ªå®šä¹‰ / ç½®é¡¶ä¼˜å…ˆ</option>
              <option value="timeDesc">æ—¶é—´ï¼šæ–° â†’ æ—§</option>
              <option value="timeAsc">æ—¶é—´ï¼šæ—§ â†’ æ–°</option>
            </select>
          </div>
          <div class="gallery-grid" id="workGrid"></div>
          <div class="empty-tip" id="workEmpty">è¿˜æ²¡æœ‰å®šç¨¿ä½œå“ï¼Œå¯ä»¥å…ˆåœ¨ã€Œè®°ä¸€ç¬”ã€é‡Œä¿å­˜ã€‚</div>
          <hr style="border:none;border-top:1px dashed #e5e7eb;margin:12px 0;" />
          <h3 class="section-title" style="font-size:14px;">åˆ¶å“ç›¸å†Œ <span class="sub">æŒ‰åˆ¶å“åè‡ªåŠ¨åˆ†æ–‡ä»¶å¤¹</span></h3>
          <div class="gallery-grid" id="albumGrid"></div>
          <div class="empty-tip" id="albumEmpty">æš‚æ— åˆ¶å“ç›¸å†Œã€‚</div>
        </div>
      </section>

      <section class="tab-panel" id="tab-feedback">
        <div class="card">
          <h2 class="section-title">ğŸ“¸ è¿”å›¾å¢™ <span class="sub">æ­£ä¸»è®¤è¯ / åˆ¶å“è¿”å›¾</span></h2>
          <div style="font-size:12px;color:var(--text-sub);margin-bottom:6px;">
            é»˜è®¤å…¨éƒ¨ä¸ºã€Œåˆ¶å“è¿”å›¾ã€ï¼Œåœ¨ä½œå“è¯¦æƒ…ä¸­å¯å°†éƒ¨åˆ†æ ‡è®°ä¸ºã€Œæ­£ä¸»è®¤è¯ã€ã€‚
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:12px;">
            <div style="flex:1 1 260px;">
              <span class="badge success">ğŸ† æ­£ä¸»è®¤è¯</span>
              <div class="gallery-grid" id="fbOfficialGrid" style="margin-top:6px;"></div>
              <div class="empty-tip" id="fbOfficialEmpty">æš‚æ— æ­£ä¸»è®¤è¯è¿”å›¾ã€‚</div>
            </div>
            <div style="flex:1 1 260px;">
              <span class="badge">ğŸ åˆ¶å“è¿”å›¾</span>
              <div class="gallery-grid" id="fbProductGrid" style="margin-top:6px;"></div>
              <div class="empty-tip" id="fbProductEmpty">æš‚æ— åˆ¶å“è¿”å›¾ã€‚</div>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" id="tab-materials">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 class="section-title">ğŸ“¦ ç´ æåº“</h2>
            <select id="selSortMat" style="max-width:150px;">
              <option value="timeDesc">æ—¶é—´ï¼šæ–° â†’ æ—§</option>
              <option value="timeAsc">æ—¶é—´ï¼šæ—§ â†’ æ–°</option>
              <option value="priceDesc">é‡‘é¢ï¼šé«˜ â†’ ä½</option>
            </select>
          </div>
          <div style="font-size:12px;color:#b91c1c;margin-bottom:4px;">æ€»æ”¯å‡ºï¼š<span id="matTotal">Â¥0.00</span></div>
          <div class="mat-grid" id="matGrid"></div>
          <div class="empty-tip" id="matEmpty">ç´ æåº“è¿˜æ˜¯ç©ºçš„ã€‚</div>
        </div>
      </section>

      <section class="tab-panel" id="tab-clients">
        <div class="card">
          <h2 class="section-title">ğŸ€ å®¢å¦¹ä»¬ <span class="sub">éå®¢å• & è´¡çŒ®æ¦œ</span></h2>
          <div class="clients-grid">
            <div>
              <span class="badge">éå®¢å• Â· B1ux</span>
              <div class="non-client-list" id="nonClientList"></div>
            </div>
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span class="badge">è´¡çŒ®æ¦œ</span>
                <select id="selClientSort" style="max-width:150px;">
                  <option value="amountDesc">ğŸ’° æŒ‰é‡‘é¢</option>
                  <option value="timeAsc">ğŸ“… æŒ‰å…¥å‘æ—¶é—´</option>
                </select>
              </div>
              <table class="client-table">
                <thead>
                  <tr>
                    <th style="width:40px;">åæ¬¡</th>
                    <th>å®¢å¦¹</th>
                    <th>çº¦ç¨¿æ¬¡æ•°</th>
                    <th>è´¡çŒ®æ€»é¢</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="clientTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" id="tab-analysis">
        <div class="card">
          <h2 class="section-title">ğŸ“Š åˆ¶å“æ•°é‡æ’è¡Œ <span class="sub">åªç»Ÿè®¡å·²å®šç¨¿ä½œå“</span></h2>
          <div style="font-size:12px;color:var(--text-sub);margin-bottom:6px;">
            Set å†…æ¯ä¸ªåˆ¶å“å•ç‹¬ +1ï¼Œä¾‹å¦‚ã€Œä»Šå±¿ Setã€ä¸­å« Logo + æ‰‹å¹…ï¼Œåˆ™ Logo å’Œæ‰‹å¹…å„è®°ä¸€æ¬¡ã€‚
          </div>
          <div id="rankList"></div>
          <div class="empty-tip" id="rankEmpty">è¿˜æ²¡æœ‰ç»Ÿè®¡æ•°æ®ã€‚</div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal" id="detailModal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="detailTitle">ä½œå“è¯¦æƒ…</h3>
        <button class="modal-close" data-close="detailModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="detail-layout">
          <div>
            <div class="detail-tags" id="detailTags"></div>
            <div class="detail-images" id="detailImages"></div>
            <div style="margin-top:8px;">
              <span class="badge">ğŸ“¸ è¿”å›¾</span>
              <div class="detail-images" id="detailFeedbackImgs" style="margin-top:4px;"></div>
              <div id="detailFeedbackEmpty" style="font-size:12px;color:var(--text-sub);">æš‚æ— è¿”å›¾ã€‚</div>
            </div>
          </div>
          <div>
            <div id="detailClient"></div>
            <div id="detailDates"></div>
            <div id="detailMoney"></div>
            <div id="detailItems"></div>
            <div id="detailRemark" class="detail-rem" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-edit btn-sm" id="btnEditDetail">âœï¸ ä¿®æ”¹</button>
        <button class="btn-danger btn-sm" id="btnDeleteDetail">ğŸ—‘ï¸ åˆ é™¤</button>
      </div>
    </div>
  </div>

  <div class="modal" id="priceModal">
    <div class="modal-card" style="max-width:620px;">
      <div class="modal-header">
        <h3>âš™ï¸ ä»·æ ¼è¡¨</h3>
        <button class="modal-close" data-close="priceModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div style="font-size:12px;color:var(--text-sub);margin-bottom:4px;">
          æ‰‹åŠ¨ç»´æŠ¤ï¼šåˆ¶å“å + ç±»å‹ï¼ˆä¸ƒç§ï¼‰+ é»˜è®¤å•ä»·ã€‚å½•å…¥ä½œå“æ—¶å¯é€‰æ‹©å¹¶è‡ªåŠ¨å¸¦å‡ºå•ä»·ï¼Œä¹Ÿå¯ä»¥ç°åœºä¿®æ”¹ã€‚
        </div>
        <div class="price-table" id="priceTable"></div>
      </div>
      <div class="modal-footer" style="justify-content:space-between;">
        <button type="button" class="btn btn-sm" id="btnAddPriceRow">+ æ–°å¢ä¸€è¡Œ</button>
        <button type="button" class="btn btn-sm" id="btnSavePrice">æ›´æ–°ä»·æ ¼è¡¨</button>
      </div>
    </div>
  </div>

  <div class="modal" id="clientModal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="clientModalTitle">å®¢å¦¹ä½œå“</h3>
        <button class="modal-close" data-close="clientModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="backup-row">
          æš‚ä¸æä¾›ä¸€é”®æ”¹åï¼›éœ€è¦æ”¹åæ—¶ï¼Œå¯ä»¥åœ¨ä½œå“è¯¦æƒ…ä¸­ä¿®æ”¹å®¢æˆ·ååé‡æ–°ä¿å­˜ã€‚
        </div>
        <div id="clientWorksList" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <datalist id="typeList"></datalist>
  <script>
    // ========= åŸºç¡€æ•°æ®ç»“æ„ =========
    const DB_NAME = 'B1uxArtStudioDB_v2';
    const DB_VERSION = 1;
    let idb = null;

    let db = {
      works: [],
      materials: [],
      priceConfig: []
    };

    let currentMonthDate = null;
    let editingWorkId = null;
    let detailCurrentId = null;

    let workImgBuffer = [];
    let feedbackImgBuffer = [];

    // ========= æ—¶é—´å·¥å…·ï¼ˆç»Ÿä¸€åŒ—äº¬æ—¶é—´ï¼‰ =========
    function getBeijingNow() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 8 * 3600000);
    }

    function getBeijingTodayDate() {
      const d = getBeijingNow();
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function formatDate(d) {
      if (!d) return '';
      const pad = n => (n < 10 ? '0' + n : '' + n);
      return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
    }

    // ========= IndexedDB =========
    function openDB() {
      return new Promise(resolve => {
        if (!('indexedDB' in window)) {
          resolve();
          return;
        }
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const dbi = e.target.result;
          if (!dbi.objectStoreNames.contains('main')) {
            dbi.createObjectStore('main', { keyPath: 'id' });
          }
        };
        req.onsuccess = e => {
          idb = e.target.result;
          resolve();
        };
        req.onerror = () => {
          console.warn('IndexedDB æ‰“å¼€å¤±è´¥ï¼Œåªåœ¨å†…å­˜ä¸­è¿è¡Œã€‚');
          resolve();
        };
      });
    }

    function loadData() {
      return new Promise(resolve => {
        if (!idb) { resolve(); return; }
        const tx = idb.transaction('main', 'readonly');
        const store = tx.objectStore('main');
        const req = store.get('b1ux-data');
        req.onsuccess = () => {
          if (req.result && req.result.data) {
            db = req.result.data;
            if (!db.works) db.works = [];
            if (!db.materials) db.materials = [];
            if (!db.priceConfig) db.priceConfig = [];
          }
          resolve();
        };
        req.onerror = () => resolve();
      });
    }

    function saveData() {
      return new Promise(resolve => {
        if (!idb) { resolve(); return; }
        const tx = idb.transaction('main', 'readwrite');
        const store = tx.objectStore('main');
        store.put({ id: 'b1ux-data', data: db });
        tx.oncomplete = () => resolve();
        tx.onerror = () => resolve();
      });
    }

    // ========= å°å·¥å…· =========
    function nextId(list) {
      let max = 0;
      list.forEach(it => {
        if (typeof it.id === 'number' && it.id > max) max = it.id;
      });
      return max + 1;
    }

    function money(n) {
      const x = Number(n || 0);
      return 'Â¥' + x.toFixed(2);
    }

    function getCurrentType() {
      const btns = document.querySelectorAll('#typeSwitch button');
      for (const b of btns) {
        if (b.classList.contains('active')) return b.dataset.type;
      }
      return 'single';
    }

    function ensureCurrentMonth() {
      if (!currentMonthDate) {
        const today = getBeijingTodayDate();
        currentMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);
      }
    }

    function setMonthInput() {
      ensureCurrentMonth();
      const y = currentMonthDate.getFullYear();
      const m = currentMonthDate.getMonth() + 1;
      const pad = n => (n < 10 ? '0' + n : '' + n);
      const monthInput = document.getElementById('monthInput');
      monthInput.value = y + '-' + pad(m);
    }

    function clearWorkForm() {
      document.getElementById('workAttr').value = '';
      document.getElementById('workClient').value = '';
      document.getElementById('workUsage').value = 'è‡ªç”¨';
      document.getElementById('workVisibility').value = 'å…¬å¼€';
      document.getElementById('workRaw').value = '';
      document.getElementById('workDiscount').value = '1';
      document.getElementById('workAmount').value = '';
      document.getElementById('workDate').value = '';
      document.getElementById('workDue').value = '';
      document.getElementById('workRemark').value = '';
      document.getElementById('chkOverview').checked = false;
      workImgBuffer = [];
      feedbackImgBuffer = [];
      renderWorkPreview();
      renderFeedbackPreview();
      
      // é‡ç½®ä¸ºå•å“æ¨¡å¼
      const btns = document.querySelectorAll('#typeSwitch button');
      btns.forEach(b => b.classList.remove('active'));
      btns[0].classList.add('active'); // å•å“ active
      initSetRowsForType('single');
    }

    // ========= Set è¡Œ & ä»·æ ¼è”åŠ¨ =========
    // æ ¸å¿ƒä¿®å¤ï¼šåˆå§‹åŒ–æ—¶æ ¹æ®ç±»å‹å†³å®šâ€œæ·»åŠ â€æŒ‰é’®æ˜¾éšï¼Œå¹¶åˆ·æ–°è¡Œçš„æ ·å¼
    function initSetRowsForType(type) {
      const wrap = document.getElementById('setRows');
      wrap.innerHTML = '';
      addSetRow(); // é»˜è®¤åŠ ä¸€è¡Œ
      
      const btnAdd = document.getElementById('btnAddRow');
      const hint = document.getElementById('setHint');
      
      if (type === 'set') {
        btnAdd.style.display = 'inline-flex'; // Setæ¨¡å¼æ˜¾ç¤ºæŒ‰é’®
        hint.textContent = 'Setï¼šæŒ‰æœ€ç»ˆæˆå“é¡ºåºæ·»åŠ å„ä¸ªåˆ¶å“ï¼ˆLogo / æ‰‹å¹…ç­‰ï¼‰ã€‚';
      } else {
        btnAdd.style.display = 'none'; // å•å“æ¨¡å¼éšè—æŒ‰é’®
        hint.textContent = 'å•å“ï¼šä¿ç•™ä¸€æ¡åˆ¶å“å³å¯ã€‚';
      }
      
      // åˆ·æ–°æ‰€æœ‰è¡Œçš„åˆ é™¤æŒ‰é’®çŠ¶æ€
      updateAllRowsDeleteState(type);
    }

    function updateAllRowsDeleteState(type) {
      const rows = document.querySelectorAll('#setRows .row-group');
      rows.forEach(row => {
        if (type === 'single') {
          row.classList.add('single-mode'); // CSSä¸­éšè— .del
        } else {
          row.classList.remove('single-mode');
        }
      });
    }

    function addSetRow(name = '', subtype = 'é»˜è®¤å•é¢', price = '', rate = '1', customRate = '') {
      const wrap = document.getElementById('setRows');
      const row = document.createElement('div');
      row.className = 'row-group';
      if (getCurrentType() === 'single') {
        row.classList.add('single-mode');
      }
      
      row.draggable = true;
      // æ³¨æ„ï¼šè¿™é‡Œå¢åŠ äº† .row-rate (ä¸‹æ‹‰æ¡†) å’Œ .row-rate-custom (è‡ªå®šä¹‰æ•°å­—)
      row.innerHTML = `
        <span class="drag">â˜°</span>
        <input type="text" list="typeList" placeholder="åˆ¶å“å" class="row-name" style="width:100px;">
        <select class="row-subtype" style="width:85px;">
          <option value="é»˜è®¤å•é¢">é»˜è®¤å•é¢</option>
          <option value="é»˜è®¤åŒé¢">é»˜è®¤åŒé¢</option>
          <option value="å•é¢">å•é¢</option>
          <option value="åŒé¢">åŒé¢</option>
          <option value="ä¸‰é¢">ä¸‰é¢</option>
          <option value="å››é¢">å››é¢</option>
          <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
        </select>
        
        <select class="row-rate" style="width:75px;background:#f0f9ff;border-color:#b9e0ff;">
          <option value="1">è‡ªç”¨ *1</option>
          <option value="1.8">å•†ç”¨ *1.8</option>
          <option value="2.5">ä¹°æ–­ *2.5</option>
          <option value="0">æ— å¿ *0</option>
          <option value="custom">è‡ªå®šä¹‰</option>
        </select>
        <input type="number" step="0.1" class="row-rate-custom" placeholder="å€æ•°" style="width:50px;display:none;background:#f0f9ff;" />

        <input type="number" step="0.01" placeholder="å•ä»·" class="row-price" style="width:80px;">
        <button type="button" class="del">Ã—</button>
      `;
      wrap.appendChild(row);

      const nameInput = row.querySelector('.row-name');
      const subtypeSelect = row.querySelector('.row-subtype');
      const rateSelect = row.querySelector('.row-rate');
      const custRateInput = row.querySelector('.row-rate-custom');
      const priceInput = row.querySelector('.row-price');

      if (name) nameInput.value = name;
      if (subtype) subtypeSelect.value = subtype;
      if (rate) rateSelect.value = rate;
      // å¦‚æœæ˜¯è‡ªå®šä¹‰å€ç‡ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†å¹¶èµ‹å€¼
      if (rate === 'custom') {
        custRateInput.style.display = 'inline-block';
        if (customRate) custRateInput.value = customRate;
      }
      if (price !== '') priceInput.value = price;

      bindSetRowEvents(row);
      
      // æ·»åŠ å®Œè¡Œåï¼Œç«‹å³è§¦å‘ä¸€æ¬¡æ€»æŠ˜æ‰£è®¡ç®—
      recalcWorkAmount(); 
    }

    function bindSetRowEvents(row) {
      const wrap = document.getElementById('setRows');
      const delBtn = row.querySelector('.del');
      const nameInput = row.querySelector('.row-name');
      const subtypeSelect = row.querySelector('.row-subtype');
      const priceInput = row.querySelector('.row-price');
      // æ–°å¢ç›‘å¬å¯¹è±¡
      const rateSelect = row.querySelector('.row-rate');
      const custRateInput = row.querySelector('.row-rate-custom');

      delBtn.onclick = () => {
        const type = getCurrentType();
        if (type === 'single') {
          alert('å•å“æ¨¡å¼ä¸‹å¿…é¡»ä¿ç•™ä¸€ä¸ªåˆ¶å“ã€‚');
          return;
        }
        row.remove();
        recalcWorkAmount(); // åˆ é™¤è¡Œåé‡æ–°è®¡ç®—æ€»æŠ˜æ‰£
      };

      // ç»Ÿä¸€å¤„ç†å‡½æ•°ï¼šæ”¹åã€æ”¹ç±»å‹ã€æ”¹å€ç‡éƒ½ä¼šè§¦å‘ä»·æ ¼é‡ç®—
      function onSmartChange() {
        // æ§åˆ¶è‡ªå®šä¹‰è¾“å…¥æ¡†çš„æ˜¾ç¤º/éšè—
        if (rateSelect.value === 'custom') {
          custRateInput.style.display = 'inline-block';
        } else {
          custRateInput.style.display = 'none';
        }
        
        autoFillRowPrice(row); // é‡æ–°è®¡ç®—å•è¡Œä»·æ ¼
        recalcWorkAmount();    // é‡æ–°è®¡ç®—æ€»ä»·
      }

      nameInput.onchange = onSmartChange;
      nameInput.oninput = onSmartChange;
      subtypeSelect.onchange = onSmartChange;
      rateSelect.onchange = onSmartChange;
      custRateInput.oninput = onSmartChange; // è‡ªå®šä¹‰å€ç‡è¾“å…¥æ—¶ä¹Ÿå®æ—¶è®¡ç®—

      // æ‰‹åŠ¨æ”¹ä»·æ ¼ä¹Ÿä¼šè§¦å‘æ€»ä»·è®¡ç®—
      priceInput.oninput = () => recalcWorkAmount();

      row.addEventListener('dragstart', () => row.classList.add('dragging'));
      row.addEventListener('dragend', () => row.classList.remove('dragging'));

      const wrapEl = document.getElementById('setRows');
      wrapEl.ondragover = e => {
        e.preventDefault();
        const dragging = wrapEl.querySelector('.row-group.dragging');
        if (!dragging) return;
        const siblings = [...wrapEl.querySelectorAll('.row-group:not(.dragging)')];
        let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
        siblings.forEach(el => {
          const rect = el.getBoundingClientRect();
          const offset = e.clientY - rect.top - rect.height / 2;
          if (offset < 0 && offset > closest.offset) {
            closest = { offset, element: el };
          }
        });
        if (!closest.element) wrapEl.appendChild(dragging);
        else wrapEl.insertBefore(dragging, closest.element);
      };
    }

    function autoFillRowPrice(row) {
      const nameVal = row.querySelector('.row-name').value.trim();
      const subtypeSelect = row.querySelector('.row-subtype');
      const priceInput = row.querySelector('.row-price');
      
      const rateSelect = row.querySelector('.row-rate');
      const custRateInput = row.querySelector('.row-rate-custom');

      const currentSubtype = subtypeSelect.value;

      // 1. æŸ¥æ‰¾åŸºç¡€ä»·æ ¼ (æŸ¥è¡¨)
      let basePrice = 0;
      let cfg = db.priceConfig.find(p => p.name === nameVal && p.subtype === currentSubtype);
      
      // æ¨¡ç³ŠåŒ¹é…é€»è¾‘
      if (!cfg) {
        const anyMatch = db.priceConfig.find(p => p.name === nameVal);
        if (anyMatch) {
          cfg = anyMatch;
          subtypeSelect.value = cfg.subtype; // è‡ªåŠ¨ä¿®æ­£ç±»å‹
        }
      }

      if (cfg) {
        basePrice = Number(cfg.price || 0);
      }

      // 2. ç¡®å®šå€ç‡
      let multiplier = 1;
      if (rateSelect.value === 'custom') {
        multiplier = parseFloat(custRateInput.value || 0); // ä½¿ç”¨è‡ªå®šä¹‰è¾“å…¥çš„æ•°å­—
      } else {
        multiplier = parseFloat(rateSelect.value || 1);    // ä½¿ç”¨ä¸‹æ‹‰æ¡†çš„é¢„è®¾å€¼
      }

      // 3. è®¡ç®—å¹¶å¡«å…¥ (åŸºç¡€ä»· * å€ç‡)
      // åªæœ‰å½“æŸ¥åˆ°äº†åŸºç¡€ä»·ï¼Œæˆ–è€…å€ç‡ä¸º0æ—¶ï¼Œæ‰è‡ªåŠ¨ä¿®æ”¹ä»·æ ¼
      // é¿å…ç”¨æˆ·æ‰‹åŠ¨å¡«äº†ä»·æ ¼åï¼Œè¢«é”™è¯¯çš„å€ç‡è®¡ç®—è¦†ç›–ä¸ºç©º
      if (basePrice > 0 || multiplier === 0) {
        const finalPrice = basePrice * multiplier;
        priceInput.value = finalPrice.toFixed(2);
      }
    }

    function recalcWorkAmountFromRaw() {
      const rawVal = parseFloat(document.getElementById('workRaw').value || '0');
      let discount = parseFloat(document.getElementById('workDiscount').value);
      if (isNaN(discount)) discount = 1;
      if (discount < 0) discount = 0;
      const amt = rawVal * discount;
      document.getElementById('workAmount').value = amt ? amt.toFixed(2) : '';
    }

    function recalcWorkAmount() {
      // 1. è®¡ç®—åŸä»·åˆè®¡
      let totalRaw = 0;
      const rows = document.querySelectorAll('#setRows .row-group');
      rows.forEach(row => {
        const val = parseFloat(row.querySelector('.row-price').value || '0');
        totalRaw += val;
      });

      if (totalRaw >= 0) {
        document.getElementById('workRaw').value = totalRaw.toFixed(2);
      }

      // 2. è‡ªåŠ¨åˆ¤æ–­æŠ˜æ‰£ (Set æ¨¡å¼é€»è¾‘)
      const type = getCurrentType(); // è·å–å½“å‰æ˜¯ å•å“ è¿˜æ˜¯ Set
      const discountInput = document.getElementById('workDiscount');
      
      if (type === 'set') {
        const count = rows.length;
        if (count >= 6) {
          discountInput.value = '0.8'; // 6ä¸ªåŠä»¥ä¸Š 8æŠ˜
        } else if (count >= 3) {
          discountInput.value = '0.9'; // 3ä¸ªåŠä»¥ä¸Š 9æŠ˜
        } else {
          discountInput.value = '1';   // å…¶ä»–æƒ…å†µä¸æ‰“æŠ˜
        }
      } else {
        // å•å“æ¨¡å¼é»˜è®¤ä¸å¼ºåˆ¶æ”¹æŠ˜æ‰£ï¼Œæˆ–è€…é‡ç½®ä¸º1ï¼Œçœ‹ä½ ä¹ æƒ¯
        // è¿™é‡Œå»ºè®®ä¿æŒä¸º1ï¼Œé™¤éç”¨æˆ·è‡ªå·±æ”¹è¿‡ï¼Œä½†ä¸ºäº†é€»è¾‘ç»Ÿä¸€ï¼Œåˆ‡å›å•å“é‡ç½®ä¸º1æ¯”è¾ƒå¥½
        discountInput.value = '1';
      }

      // 3. è®¡ç®—å®æ”¶
      recalcWorkAmountFromRaw();
    }

    // ========= å›¾ç‰‡é¢„è§ˆ =========
    function handleImageFiles(files, buffer, renderFn, maxCount = 10) {
      if (!files || !files.length) return;
      const remain = maxCount - buffer.length;
      const list = [...files].slice(0, Math.max(0, remain));
      if (!list.length) return;
      let loaded = 0;
      list.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          buffer.push(e.target.result);
          loaded++;
          if (loaded === list.length) renderFn();
        };
        reader.readAsDataURL(file);
      });
    }

    function renderWorkPreview() {
      const grid = document.getElementById('workImgGrid');
      grid.innerHTML = '';
      workImgBuffer.forEach((src, idx) => {
        const box = document.createElement('div');
        box.className = 'img-box';
        box.draggable = true;
        box.innerHTML = `
          <img src="${src}">
          <span class="idx">${idx + 1}</span>
          <button type="button" class="rm">Ã—</button>
        `;
        box.querySelector('.rm').onclick = e => {
          e.stopPropagation();
          workImgBuffer.splice(idx, 1);
          renderWorkPreview();
        };
        box.addEventListener('dragstart', () => box.classList.add('dragging'));
        box.addEventListener('dragend', () => box.classList.remove('dragging'));
        grid.appendChild(box);
      });

      grid.ondragover = e => {
        e.preventDefault();
        const dragging = grid.querySelector('.img-box.dragging');
        if (!dragging) return;
        const boxes = [...grid.querySelectorAll('.img-box:not(.dragging)')];
        let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
        boxes.forEach(el => {
          const rect = el.getBoundingClientRect();
          const offset = e.clientY - rect.top - rect.height / 2;
          if (offset < 0 && offset > closest.offset) {
            closest = { offset, element: el };
          }
        });
        if (!closest.element) grid.appendChild(dragging);
        else grid.insertBefore(dragging, closest.element);

        const newOrder = [];
        grid.querySelectorAll('.img-box img').forEach(img => newOrder.push(img.src));
        workImgBuffer = newOrder;
        grid.querySelectorAll('.idx').forEach((span, i) => span.textContent = i + 1);
      };
    }

    function renderFeedbackPreview() {
      const grid = document.getElementById('feedbackImgGrid');
      grid.innerHTML = '';
      feedbackImgBuffer.forEach((src, idx) => {
        const box = document.createElement('div');
        box.className = 'img-box';
        box.innerHTML = `
          <img src="${src}">
          <span class="idx">${idx + 1}</span>
          <button type="button" class="rm">Ã—</button>
        `;
        box.querySelector('.rm').onclick = () => {
          feedbackImgBuffer.splice(idx, 1);
          renderFeedbackPreview();
        };
        grid.appendChild(box);
      });
    }

    // ========= è‡ªåŠ¨å‘½å =========
    function generateAutoName(attr, type, items, excludeId) {
      const firstItemName = items[0] ? (items[0].name || 'ä½œå“') : 'ä½œå“';
      const base = attr + ' ' + (type === 'set' ? 'set' : firstItemName);
      const same = db.works.filter(w => {
        if (w.id === excludeId) return false;
        if (w.attr !== attr) return false;
        if (w.type !== type) return false;
        const wFirst = (w.items && w.items[0] && w.items[0].name) ? w.items[0].name : 'ä½œå“';
        return type === 'set' || wFirst === firstItemName;
      });
      const idx = same.length + 1;
      return base + ' ' + idx;
    }

    function renumberWorks(attr, type, firstItemName) {
      // 1. ç¡®å®šâ€œåŸºå‡†åâ€
      const baseNameStr = attr + ' ' + (type === 'set' ? 'set' : firstItemName);

      // 2. æ‰¾å‡ºåŒç»„ä½œå“
      const group = db.works.filter(w => {
        const wFirst = (w.items && w.items[0] && w.items[0].name) ? w.items[0].name : 'ä½œå“';
        return w.attr === attr && (
           (type === 'set' && w.type === 'set') || 
           (type === 'single' && w.type === 'single' && wFirst === firstItemName)
        );
      });

      // 3. æ’åºæ ¸å¿ƒï¼šæ—¥æœŸè¶Šæ—©ï¼Œæ’åœ¨è¶Šå‰é¢ï¼ˆIndexè¶Šå°ï¼Œç¼–å·è¶Šå°ï¼‰
      group.sort((a, b) => {
        // è·å–æœ‰æ•ˆæ—¥æœŸï¼šä¼˜å…ˆ å®šç¨¿æ—¥ > æ’å•æ—¥ > åˆ›å»ºæ—¶é—´
        // å¦‚æœæ•°æ®å®Œå…¨ç¼ºå¤±ï¼Œç”¨ '9999' å«åº•
        const tA = a.date || a.due || a.createdAt || '9999-12-31';
        const tB = b.date || b.due || b.createdAt || '9999-12-31';

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ç‚¹ â˜…â˜…â˜…
        // tA.localeCompare(tB) = å‡åº (Old -> New)
        // 2023-01-01 ä¼šæ’åœ¨ 2023-12-31 å‰é¢
        return tA.localeCompare(tB);
      });

      // 4. é‡æ–°åˆ†é…ç¼–å·
      // æ’åœ¨ç¬¬ä¸€ä¸ªçš„ï¼ˆæœ€æ—©çš„ï¼‰è·å¾— #1
      group.forEach((w, index) => {
        w.autoName = baseNameStr + ' ' + (index + 1);
      });
    }

    // === ä¿®æ”¹åï¼šæäº¤ä½œå“å‡½æ•° ===
    function handleWorkSubmit(e) {
      e.preventDefault();
      const attr = document.getElementById('workAttr').value.trim();
      let client = document.getElementById('workClient').value.trim();
      const usage = document.getElementById('workUsage').value;
      const visibility = document.getElementById('workVisibility').value;
      let raw = parseFloat(document.getElementById('workRaw').value || '0');
      let discount = parseFloat(document.getElementById('workDiscount').value);
      if (isNaN(discount)) discount = 1;
      const amountInput = document.getElementById('workAmount').value;
      let amount = amountInput ? parseFloat(amountInput) : raw * discount;
      if (isNaN(amount)) amount = 0;

      const dateStr = document.getElementById('workDate').value;
      const dueStr = document.getElementById('workDue').value;
      const remark = document.getElementById('workRemark').value.trim();
      const type = getCurrentType();

      if (!attr) {
        alert('è¯·å¡«å†™å±æ€§ï¼Œä¾‹å¦‚ï¼šä»Šå±¿');
        return;
      }
      if (dateStr && dueStr) {
        alert('å®šç¨¿æ—¥æœŸ å’Œ æˆªæ­¢æ—¥æœŸ åªèƒ½å¡«ä¸€ä¸ªã€‚');
        return;
      }
      if (!dateStr && !dueStr) {
        alert('å®šç¨¿æ—¥æœŸ å’Œ æˆªæ­¢æ—¥æœŸ å¿…é¡»å¡«ä¸€ä¸ªã€‚');
        return;
      }
      if (!client) client = 'æœªçŸ¥';

      const items = [];
      document.querySelectorAll('#setRows .row-group').forEach(row => {
        const name = row.querySelector('.row-name').value.trim() || 'æœªå‘½ååˆ¶å“';
        const subtype = row.querySelector('.row-subtype').value;
        const price = parseFloat(row.querySelector('.row-price').value || '0');
        // è·å–å€ç‡å’Œè‡ªå®šä¹‰å€ç‡
        const rate = row.querySelector('.row-rate').value;
        const customRate = row.querySelector('.row-rate-custom').value;

        items.push({ name, subtype, price, rate, customRate });
      });
      
      if (items.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåˆ¶å“ã€‚');
        return;
      }

      if (!raw) {
        raw = items.reduce((sum, it) => sum + (it.price || 0), 0);
      }
      
      const images = [...workImgBuffer];
      const feedback = feedbackImgBuffer.map(src => ({ src, category: 'product' }));
      const hasOverview = document.getElementById('chkOverview').checked;
      const now = getBeijingNow().toISOString();

      // æ„å»ºå½“å‰ä½œå“å¯¹è±¡
      const newWorkObj = {
        id: editingWorkId != null ? editingWorkId : nextId(db.works),
        attr,
        client,
        usage,
        visibility,
        raw,
        discount,
        amount,
        date: dateStr || null,
        due: dueStr || null,
        remark,
        type,
        items,
        images,
        feedback,
        pinned: false, // é»˜è®¤å€¼
        hasOverview,
        createdAt: editingWorkId != null ? undefined : now // ç¼–è¾‘æ—¶ä¸æ”¹åˆ›å»ºæ—¶é—´
      };

      // 1. å…ˆä¿å­˜/æ›´æ–°æ•°æ®è¿›æ•°ç»„
      if (editingWorkId != null) {
        const idx = db.works.findIndex(w => w.id === editingWorkId);
        if (idx !== -1) {
          // ä¿ç•™æ—§çš„ pinned çŠ¶æ€å’Œ createdAt
          newWorkObj.pinned = db.works[idx].pinned;
          newWorkObj.createdAt = db.works[idx].createdAt;
          db.works[idx] = newWorkObj;
        }
      } else {
        db.works.push(newWorkObj);
      }

      // 2. ã€å…³é”®ã€‘æ•°æ®å…¥åº“åï¼Œç«‹åˆ»è§¦å‘å…¨ç»„é‡æ–°æ’åºå‘½å
      const firstItemName = items[0] ? items[0].name : 'ä½œå“';
      renumberWorks(attr, type, firstItemName);

      // 3. æ¸…ç†æ”¶å°¾
      editingWorkId = null;
      detailCurrentId = null;
      document.getElementById('editBar').classList.remove('show');
      document.getElementById('btnSubmitWork').textContent = 'æäº¤ä½œå“æ”¶å…¥';

      saveData().then(() => {
        renderAll();
        alert('âœ… ä½œå“å·²ä¿å­˜ï¼Œå¹¶å·²æŒ‰æ—¶é—´è‡ªåŠ¨é‡æ–°ç¼–å·');
        clearWorkForm();
      });
    }

    // ========= ç´ ææäº¤ =========
    function handleMatSubmit(e) {
      e.preventDefault();
      const name = document.getElementById('matName').value.trim();
      const merchant = document.getElementById('matMerchant').value.trim();
      const price = parseFloat(document.getElementById('matPrice').value || '0');
      let dateStr = document.getElementById('matDate').value;
      const remark = document.getElementById('matRemark').value.trim();

      if (!name || !price) {
        alert('è¯·å¡«å†™ç´ æåç§°å’Œé‡‘é¢ã€‚');
        return;
      }
      if (!dateStr) {
        dateStr = formatDate(getBeijingTodayDate());
      }

      const id = nextId(db.materials);
      db.materials.push({
        id,
        name,
        merchant,
        price,
        date: dateStr,
        remark,
        createdAt: getBeijingNow().toISOString()
      });

      document.getElementById('matForm').reset();
      document.getElementById('matDate').value = formatDate(getBeijingTodayDate());

      saveData().then(() => {
        renderAll();
        alert('âœ… ç´ ææ”¯å‡ºå·²è®°å½•');
      });
    }

    // ========= ç»Ÿè®¡ =========
    function renderStats() {
      const finished = db.works.filter(w => !!w.date); // åªç»Ÿè®¡å·²å®šç¨¿
      let totalIncome = 0;
      finished.forEach(w => totalIncome += Number(w.amount || 0));
      let totalExpense = 0;
      db.materials.forEach(m => totalExpense += Number(m.price || 0));
      const net = totalIncome - totalExpense;

      document.getElementById('statIncome').textContent = money(totalIncome);
      document.getElementById('statExpense').textContent = '-' + money(totalExpense).slice(1);
      document.getElementById('statCount').textContent = finished.length + ' / ' + db.materials.length;
      document.getElementById('matTotal').textContent = money(totalExpense);
      document.getElementById('statNet').textContent = 'å‡€æ”¶å…¥ï¼š' + money(net);
    }

    // ========= å®¢å¦¹ä»¬ =========
    function renderClients() {
      const works = db.works;
      const b1List = works.filter(w => w.client === 'B1ux');
      const others = works.filter(w => w.client !== 'B1ux');

      const nonClientList = document.getElementById('nonClientList');
      nonClientList.innerHTML = '';
      if (!b1List.length) {
        nonClientList.innerHTML = '<div style="font-size:12px;color:var(--text-sub);">æš‚æ—  B1ux è‡ªå·±çš„è®°å½•ã€‚</div>';
      } else {
        const sortedB1 = [...b1List].sort((a, b) => {
          const da = a.date || a.due || a.createdAt;
          const dbs = b.date || b.due || b.createdAt;
          return da.localeCompare(dbs);
        });
        sortedB1.forEach(w => {
          const div = document.createElement('div');
          div.className = 'non-client-item';
          const d = (w.date || w.due || '').slice(5);
          div.textContent = (d || '??-??') + ' Â· ' + (w.autoName || w.attr);
          div.onclick = () => openDetail(w.id);
          nonClientList.appendChild(div);
        });
      }

      // ç»Ÿè®¡è´¡çŒ®æ¦œï¼šæ’å• + å·²å®Œæˆéƒ½ç®—æ¬¡æ•°ï¼›é‡‘é¢åªç®—å·²å®Œæˆ
      const map = {};
      others.forEach(w => {
        const name = w.client || 'æœªçŸ¥';
        if (!map[name]) {
          map[name] = {
            name,
            count: 0,
            total: 0,
            earliest: w.date || w.due || w.createdAt,
            works: []
          };
        }
        map[name].count++;
        if (w.date && w.amount) {
          map[name].total += Number(w.amount);
        }
        const thisTime = w.date || w.due || w.createdAt;
        if (thisTime < map[name].earliest) {
          map[name].earliest = thisTime;
        }
        map[name].works.push(w);
      });

      let all = Object.values(map);
      const sortMode = document.getElementById('selClientSort').value;

      let unknownEntry = all.find(x => x.name === 'æœªçŸ¥');
      let known = all.filter(x => x.name !== 'æœªçŸ¥');

      if (sortMode === 'amountDesc') {
        known.sort((a, b) => b.total - a.total);
      } else if (sortMode === 'timeAsc') {
        known.sort((a, b) => a.earliest.localeCompare(b.earliest));
      }

      const tbody = document.getElementById('clientTableBody');
      tbody.innerHTML = '';

      if (!known.length && !unknownEntry) {
        tbody.innerHTML = '<tr><td colspan="5" style="font-size:12px;color:var(--text-sub);">è¿˜æ²¡æœ‰å®¢å¦¹çº¦ç¨¿è®°å½•ã€‚</td></tr>';
        return;
      }

      // å·²çŸ¥å®¢å¦¹ï¼šæœ‰åæ¬¡
      known.forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${c.name}</td>
          <td>${c.count}</td>
          <td>${money(c.total)}</td>
          <td><button type="button" class="btn-outline btn-sm" data-client="${c.name}" style="background:#54a3ff;color:#fff;border:none;">æŸ¥çœ‹</button></td>
        `;
        tbody.appendChild(tr);
      });

      // æœªçŸ¥ï¼šæ°¸è¿œåœ¨æœ€ä¸‹æ–¹ã€æ— åæ¬¡ï¼Œå’Œå€’æ•°ä¸€åéš”ä¸€è¡Œ
      if (unknownEntry) {
        if (known.length) {
          const spacer = document.createElement('tr');
          spacer.innerHTML = '<td colspan="5" style="border-bottom:none;height:4px;"></td>';
          tbody.appendChild(spacer);
        }
        const trU = document.createElement('tr');
        trU.innerHTML = `
          <td></td>
          <td>æœªçŸ¥</td>
          <td>${unknownEntry.count}</td>
          <td>${money(unknownEntry.total)}</td>
          <td><button type="button" class="btn-outline btn-sm" data-client="æœªçŸ¥" style="background:#54a3ff;color:#fff;border:none;">æŸ¥çœ‹</button></td>
        `;
        tbody.appendChild(trU);
      }

      tbody.querySelectorAll('button[data-client]').forEach(btn => {
        btn.onclick = () => openClientWorks(btn.getAttribute('data-client'));
      });
    }

    function openClientWorks(name) {
      const list = db.works.filter(w => (w.client || 'æœªçŸ¥') === name);
      const title = document.getElementById('clientModalTitle');
      title.textContent = name + ' çš„ä½œå“è®°å½•';
      const container = document.getElementById('clientWorksList');
      container.innerHTML = '';
      if (!list.length) {
        container.innerHTML = '<div style="font-size:12px;color:var(--text-sub);">æš‚æ— è®°å½•ã€‚</div>';
      } else {
        const sorted = [...list].sort((a, b) => {
          const da = a.date || a.due || a.createdAt;
          const dbs = b.date || b.due || b.createdAt;
          return da.localeCompare(dbs);
        });
        sorted.forEach(w => {
          const div = document.createElement('div');
          div.style.padding = '4px 0';
          const dateLabel = (w.date || w.due || '').slice(5) || '??-??';
          const status = w.date ? 'å·²å®šç¨¿' : 'æ’å•';
          div.innerHTML = `${dateLabel} Â· ${w.autoName || w.attr} <span style="font-size:11px;color:var(--text-sub);">(${status})</span>`;
          div.style.cursor = 'pointer';
          div.onclick = () => openDetail(w.id);
          container.appendChild(div);
        });
      }
      openModal('clientModal');
    }

    // ========= è¯¦ç»†ç»Ÿè®¡ =========
    function renderAnalysis() {
      const list = db.works.filter(w => !!w.date);
      const counts = {};
      list.forEach(w => {
        (w.items || []).forEach(it => {
          const name = (it.name || 'æœªå‘½ååˆ¶å“').trim();
          if (!name) return;
          counts[name] = (counts[name] || 0) + 1;
        });
      });

      const container = document.getElementById('rankList');
      const empty = document.getElementById('rankEmpty');
      container.innerHTML = '';

      const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      const max = entries[0][1];
      entries.forEach(([name, cnt], idx) => {
        const item = document.createElement('div');
        item.className = 'rank-item';
        const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : '';
        const width = Math.max(5, (cnt / max) * 100);
        item.innerHTML = `
          <div class="rank-top">
            <div class="rank-name">
              <span class="rank-medal">${medal}</span>
              <span>${name}</span>
            </div>
            <div>${cnt}</div>
          </div>
          <div class="rank-bar-bg">
            <div class="rank-bar" style="width:${width}%;"></div>
          </div>
        `;
        container.appendChild(item);
      });
    }

    // ========= ä½œå“é›† & åˆ¶å“ç›¸å†Œ =========
    // === è¯·æ›¿æ¢ function renderGallery() ===

    function renderGallery() {
      const finished = db.works.filter(w => !!w.date);
      const grid = document.getElementById('workGrid');
      const empty = document.getElementById('workEmpty');
      const sortMode = document.getElementById('selSortWorks').value;

      grid.innerHTML = '';

      if (!finished.length) {
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        
        let arr = [...finished];
        // æ’åºé€»è¾‘
        if (sortMode === 'timeDesc') {
          arr.sort((a, b) => (b.date || b.createdAt).localeCompare(a.date || a.createdAt));
        } else if (sortMode === 'timeAsc') {
          arr.sort((a, b) => (a.date || a.createdAt).localeCompare(b.date || b.createdAt));
        } else {
          // è‡ªå®šä¹‰æ’åº
          arr.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return 0; 
          });
        }

        arr.forEach(w => {
          const card = document.createElement('div');
          card.className = 'card-item';
          
          // === æ‹–æ‹½åŠŸèƒ½ ===
          if (sortMode === 'custom') {
            card.draggable = true;
            card.dataset.id = w.id;
            card.addEventListener('dragstart', (e) => {
              card.classList.add('dragging');
              e.dataTransfer.effectAllowed = 'move';
              e.dataTransfer.setData('text/plain', w.id);
            });
            card.addEventListener('dragend', () => card.classList.remove('dragging'));
            card.addEventListener('dragover', (e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
            });
            card.addEventListener('drop', (e) => {
              e.preventDefault();
              const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
              const targetId = w.id;
              if (draggedId === targetId) return;
              const fromIndex = db.works.findIndex(x => x.id === draggedId);
              const toIndex = db.works.findIndex(x => x.id === targetId);
              if (fromIndex > -1 && toIndex > -1) {
                const [movedItem] = db.works.splice(fromIndex, 1);
                db.works.splice(toIndex, 0, movedItem);
                saveData().then(renderGallery);
              }
            });
          }

          card.onclick = () => openDetail(w.id);

          // === 1. å›¾ç‰‡éƒ¨åˆ† (æ ¸å¿ƒæ‹¼å›¾é€»è¾‘) ===
          const imgDiv = document.createElement('div');
          imgDiv.className = 'card-img'; // è¿™é‡Œä¼šè¢« CSS å¼ºåˆ¶è®¾ä¸ºæ­£æ–¹å½¢

          const imgs = w.images || [];
          const count = imgs.length;

          // æ¡ä»¶ï¼šSet + æ²¡å‹¾æ€»è§ˆ + è‡³å°‘2å¼ å›¾
          if (w.type === 'set' && !w.hasOverview && count >= 2) {
            
            // 2-4å¼  -> 4å®«æ ¼; 5å¼ + -> 9å®«æ ¼
            const gridSize = count >= 5 ? 9 : 4;
            
            const gridDiv = document.createElement('div');
            gridDiv.className = `cover-grid g-${gridSize}`; 
            
            for (let i = 0; i < gridSize; i++) {
              const img = document.createElement('img');
              // å¾ªç¯å–å›¾
              img.src = imgs[i % count]; 
              // æ³¨æ„ï¼šCSS ä¼šè‡ªåŠ¨å¤„ç† object-fit: cover æŠŠå®ƒå˜æˆæ­£æ–¹å½¢
              gridDiv.appendChild(img);
            }
            imgDiv.appendChild(gridDiv);

          } else {
            // æ™®é€šé€»è¾‘ï¼šæ˜¾ç¤ºä¸€å¼ å¤§å›¾
            if (count > 0) {
              const img = document.createElement('img');
              // æœ‰æ€»è§ˆæ˜¾ç¤ºæœ€åä¸€å¼ ï¼Œå¦åˆ™ç¬¬ä¸€å¼ 
              img.src = w.hasOverview ? imgs[count - 1] : imgs[0];
              imgDiv.appendChild(img);
            } else {
              imgDiv.innerHTML = '<div class="card-img-empty">æš‚æ— é¢„è§ˆ</div>';
            }
          }
          card.appendChild(imgDiv);

          // === 2. æ–‡å­—ä¸æŒ‰é’®éƒ¨åˆ† ===
          const body = document.createElement('div');
          body.className = 'card-body';
          
          const headerRow = document.createElement('div');
          headerRow.className = 'card-header-row';

          const title = document.createElement('div');
          title.className = 'card-title';
          title.textContent = w.autoName || w.attr;
          headerRow.appendChild(title);

          const pinBtn = document.createElement('button');
          pinBtn.className = 'pin-btn' + (w.pinned ? ' pinned' : '');
          pinBtn.innerHTML = w.pinned ? 'â˜…' : 'â˜†';
          pinBtn.onclick = (e) => {
            e.stopPropagation();
            w.pinned = !w.pinned;
            saveData().then(renderGallery);
          };
          headerRow.appendChild(pinBtn);

          body.appendChild(headerRow);

          const sub = document.createElement('div');
          sub.className = 'card-sub';
          sub.textContent = (w.client || 'æœªçŸ¥') + ' Â· ' + (w.type === 'set' ? 'Set' : 'å•å“');
          body.appendChild(sub);

          card.appendChild(body);
          grid.appendChild(card);
        });
      }

      renderAlbums();
    }
    
    function renderAlbums() {
      const finished = db.works.filter(w => !!w.date);
      const map = {};

      // 1. æŒ‰æ—¶é—´å€’åº (æ–° -> æ—§)
      const sortedWorks = [...finished].sort((a, b) => 
        (b.date || b.createdAt).localeCompare(a.date || a.createdAt)
      );

      sortedWorks.forEach(w => {
        const items = w.items || [];
        const rawImages = w.images || [];
        
        // === å…³é”®ä¿®æ”¹ï¼šæŠŠæ€»è§ˆå›¾å•ç‹¬æå–å‡ºæ¥ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸¢å¼ƒ ===
        let specificPool = [...rawImages]; // ç”¨äºç²¾å‡†åŒ¹é…çš„æ± å­
        let overviewImg = null;            // æš‚å­˜æ€»è§ˆå›¾

        if (w.hasOverview && rawImages.length > 0) {
          // å¦‚æœæœ‰æ€»è§ˆï¼ŒæŠŠå®ƒä»æ± å­é‡Œæ‹¿å‡ºæ¥ï¼Œå­˜åˆ° overviewImg å˜é‡é‡Œ
          overviewImg = specificPool.pop(); 
        }
        
        items.forEach((it, itemIndex) => {
          const name = (it.name || 'æœªå‘½ååˆ¶å“').trim();
          if (!name) return;
          
          if (!map[name]) {
            map[name] = { name, count: 0, cover: null };
          }
          map[name].count++;

          // 2. è®¾ç½®å°é¢é€»è¾‘
          // å¦‚æœè¿˜æ²¡æœ‰å°é¢ï¼Œå°±å°è¯•æ‰¾ä¸€å¼ 
          if (!map[name].cover) {
            
            // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ‰¾å¯¹åº”ä½ç½®çš„å•å“å›¾ (pool[0]å¯¹åº”A, pool[1]å¯¹åº”B...)
            if (specificPool[itemIndex]) {
               map[name].cover = specificPool[itemIndex];
            } 
            // ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ²¡å¯¹åº”ä¸Šï¼Œä½†æ± å­é‡Œæœ‰åˆ«çš„å•å“å›¾ï¼Œæ‹¿ç¬¬ä¸€å¼ å‡‘æ•°
            else if (specificPool.length > 0) {
               map[name].cover = specificPool[0];
            }
            // ç¬¬ä¸‰ä¼˜å…ˆçº§ (æ–°å¢)ï¼šå•å“å›¾ä¸€å¼ éƒ½æ²¡ï¼Œä½†æ˜¯æœ‰æ€»è§ˆå›¾ï¼é‚£å°±ç”¨æ€»è§ˆå›¾ï¼
            else if (overviewImg) {
               map[name].cover = overviewImg;
            }
          }
        });
      });

      const albumsGrid = document.getElementById('albumGrid');
      const empty = document.getElementById('albumEmpty');
      albumsGrid.innerHTML = '';

      const entries = Object.values(map).sort((a, b) => b.count - a.count);
      if (!entries.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      entries.forEach(al => {
        const card = document.createElement('div');
        card.className = 'card-item';
        
        card.onclick = () => {
          const worksInAlbum = db.works.filter(w => 
            !!w.date && (w.items || []).some(it => it.name === al.name)
          );
          openWorksModal(al.name, worksInAlbum); 
        };

        const imgDiv = document.createElement('div');
        imgDiv.className = 'card-img'; 
        
        if (al.cover) {
          const img = document.createElement('img');
          img.src = al.cover;
          imgDiv.appendChild(img);
        } else {
          imgDiv.innerHTML = '<div class="card-img-empty">æš‚æ— é¢„è§ˆ</div>';
        }
        card.appendChild(imgDiv);

        const body = document.createElement('div');
        body.className = 'card-body';
        body.innerHTML = `
          <div class="card-title">${al.name}</div>
          <div class="card-sub">å…± ${al.count} ä»½æˆå“</div>
        `;
        card.appendChild(body);

        albumsGrid.appendChild(card);
      });
    }

    // === æœ€ç»ˆç¡®è®¤ç‰ˆï¼šç›¸å†Œè¯¦æƒ…å¼¹çª— ===
    function openWorksModal(filterName, worksList) {
      const title = document.getElementById('clientModalTitle');
      title.textContent = filterName + ' åˆé›†'; 
      
      const container = document.getElementById('clientWorksList');
      container.innerHTML = ''; 
      
      if (!worksList.length) {
        container.innerHTML = '<div style="font-size:12px;color:var(--text-sub);">æš‚æ— ä½œå“ã€‚</div>';
      } else {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
        grid.style.gap = '10px';
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        const sorted = [...worksList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        
        sorted.forEach(w => {
          const item = document.createElement('div');
          item.className = 'card-item';
          item.onclick = () => openDetail(w.id);
          
          const imgDiv = document.createElement('div');
          imgDiv.className = 'card-img';
          
          // === æ ¸å¿ƒæ‰¾å›¾é€»è¾‘ ===
          let imgSrc = null;
          
          // 1. å‡†å¤‡â€œå•å“å›¾ç‰‡æ± â€ (å¦‚æœå‹¾é€‰äº†æ€»è§ˆï¼Œå…ˆæŠŠæœ€åä¸€å¼ è—èµ·æ¥)
          let pool = [...(w.images || [])];
          if (w.hasOverview && pool.length > 0) pool.pop();
          
          // 2. ç¡®å®šå½“å‰åˆ¶å“æ’è€å‡ ï¼Ÿ
          const items = w.items || [];
          let targetIndex = -1;
          for(let i=0; i<items.length; i++) {
             if(items[i].name === filterName) {
                 targetIndex = i;
                 break;
             }
          }

          // === ä¼˜å…ˆçº§åˆ¤æ–­ ===
          
          // æƒ…å†µ A: ç²¾å‡†åŒ¹é… (ç¬¬2ä¸ªåˆ¶å“æ‰¾ç¬¬2å¼ å•å“å›¾)
          if (targetIndex !== -1 && targetIndex < pool.length) {
              imgSrc = pool[targetIndex];
          } 
          // æƒ…å†µ B: æ²¡å¯¹ä¸Šï¼Œä½†æœ‰å…¶ä»–å•å“å›¾ (æ˜¾ç¤ºç¬¬1å¼ å•å“å›¾)
          else if (pool.length > 0) {
              imgSrc = pool[0];
          } 
          // æƒ…å†µ C: å•å“æ± ç©ºäº† (è¯´æ˜åªæœ‰ä¸€å¼ å›¾ä¸”å®ƒæ˜¯æ€»è§ˆå›¾)ï¼Œé‚£å°±æ˜¾ç¤ºæ€»è§ˆå›¾
          else if (w.images && w.images.length > 0) {
              imgSrc = w.images[0];
          }

          // æ¸²æŸ“å›¾ç‰‡
          if (imgSrc) {
             const img = document.createElement('img');
             img.src = imgSrc;
             imgDiv.appendChild(img);
          } else {
             imgDiv.innerHTML = '<div class="card-img-empty">æ— å›¾</div>';
          }
          // === é€»è¾‘ç»“æŸ ===

          item.appendChild(imgDiv);
          
          const body = document.createElement('div');
          body.className = 'card-body';
          body.innerHTML = `
            <div class="card-title" style="font-size:12px;">${w.autoName || w.attr}</div>
            <div class="card-sub" style="font-size:11px;">${w.date}</div>
          `;
          item.appendChild(body);
          
          grid.appendChild(item);
        });
        
        container.appendChild(grid);
      }
      
      openModal('clientModal');
    }

    // ========= ç´ æåº“ =========
    function renderMaterials() {
      const grid = document.getElementById('matGrid');
      const empty = document.getElementById('matEmpty');
      grid.innerHTML = '';

      let arr = [...db.materials];
      if (!arr.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      const mode = document.getElementById('selSortMat').value;
      if (mode === 'timeDesc') {
        arr.sort((a, b) => (b.date || b.createdAt).localeCompare(a.date || a.createdAt));
      } else if (mode === 'timeAsc') {
        arr.sort((a, b) => (a.date || a.createdAt).localeCompare(b.date || b.createdAt));
      } else if (mode === 'priceDesc') {
        arr.sort((a, b) => (b.price || 0) - (a.price || 0));
      }

      arr.forEach(m => {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.style.cursor = 'default';

        const imgDiv = document.createElement('div');
        imgDiv.className = 'card-img';
        imgDiv.textContent = 'ç´ æ';
        card.appendChild(imgDiv);

        const body = document.createElement('div');
        body.className = 'card-body';
        body.innerHTML = `
          <div class="card-title">${m.name}</div>
          <div class="card-sub">${m.merchant || 'æœªçŸ¥å•†å®¶'}</div>
          <div style="font-size:12px;margin-top:2px;">${m.date || ''} Â· ${money(m.price)}</div>
        `;
        card.appendChild(body);

        grid.appendChild(card);
      });
    }

    // ========= è¿”å›¾å¢™ =========
    function renderFeedbackWall() {
      const officialGrid = document.getElementById('fbOfficialGrid');
      const productGrid = document.getElementById('fbProductGrid');
      const offEmpty = document.getElementById('fbOfficialEmpty');
      const prodEmpty = document.getElementById('fbProductEmpty');

      officialGrid.innerHTML = '';
      productGrid.innerHTML = '';

      const official = [];
      const product = [];

      db.works.forEach(w => {
        (w.feedback || []).forEach((f, idx) => {
          const item = { workId: w.id, idx, src: f.src, category: f.category || 'product' };
          if (item.category === 'official') official.push(item);
          else product.push(item);
        });
      });

      if (!official.length) offEmpty.style.display = 'block';
      else offEmpty.style.display = 'none';
      if (!product.length) prodEmpty.style.display = 'block';
      else prodEmpty.style.display = 'none';

      function makeCard(item, target) {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.onclick = () => openDetail(item.workId);
        const imgDiv = document.createElement('div');
        imgDiv.className = 'card-img';
        const img = document.createElement('img');
        img.src = item.src;
        imgDiv.appendChild(img);
        card.appendChild(imgDiv);
        const body = document.createElement('div');
        body.className = 'card-body';
        body.innerHTML = `<div class="card-title">ä½œå“ #${item.workId}</div>`;
        card.appendChild(body);
        target.appendChild(card);
      }

      official.forEach(it => makeCard(it, officialGrid));
      product.forEach(it => makeCard(it, productGrid));
    }

    // ========= æ—¥å† =========
    function renderCalendar() {
      ensureCurrentMonth();
      setMonthInput();

      const head = document.getElementById('calendarHead');
      const body = document.getElementById('calendarBody');
      const todoList = document.getElementById('todoList');
      head.innerHTML = '';
      body.innerHTML = '';
      todoList.innerHTML = '';

      const weekNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      weekNames.forEach(d => {
        const div = document.createElement('div');
        div.className = 'cal-cell-head';
        div.textContent = d;
        head.appendChild(div);
      });

      const year = currentMonthDate.getFullYear();
      const month = currentMonthDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const startDow = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevMonthDays = new Date(year, month, 0).getDate();
      const totalCells = 42;
      const today = getBeijingTodayDate();
      const works = db.works;

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'cal-cell';

        const dayNumEl = document.createElement('div');
        dayNumEl.className = 'cal-day-num';

        let day = i - startDow + 1;
        let cellDate;
        if (i < startDow) {
          day = prevMonthDays - (startDow - i) + 1;
          cellDate = new Date(year, month - 1, day);
          cell.classList.add('other-month');
        } else if (day > daysInMonth) {
          day = day - daysInMonth;
          cellDate = new Date(year, month + 1, day);
          cell.classList.add('other-month');
        } else {
          cellDate = new Date(year, month, day);
        }
        dayNumEl.textContent = day;
        cell.appendChild(dayNumEl);

        if (
          cellDate.getFullYear() === today.getFullYear() &&
          cellDate.getMonth() === today.getMonth() &&
          cellDate.getDate() === today.getDate()
        ) {
          cell.classList.add('today');
        }

        const cellStr = formatDate(cellDate);
        const dayWorks = works.filter(w => w.date === cellStr || w.due === cellStr);
        dayWorks.forEach(w => {
          const isDone = !!w.date && w.date === cellStr;
          const isPending = !!w.due && w.due === cellStr && !w.date;
          const tag = document.createElement('div');
          tag.className = 'cal-event ' + (isDone ? 'done' : 'pending');
          const label = w.autoName || w.attr || '';
          tag.textContent = label;
          tag.title = w.client || '';
          tag.onclick = e => {
            e.stopPropagation();
            openDetail(w.id);
          };
          // å¯¹äºåŒæ—¶æœ‰å®šç¨¿ / æˆªæ­¢ï¼ˆæ—§æ•°æ®ï¼‰ï¼Œåªæ˜¾ç¤ºä¸€æ¬¡
          if (isDone || isPending) {
            cell.appendChild(tag);
          }
        });

        body.appendChild(cell);
      }

      // å¾…åŠæ¸…å•ï¼šæœ¬æœˆå†…åªæœ‰æˆªæ­¢æ—¥æœŸã€æœªå®šç¨¿
      const currYear = currentMonthDate.getFullYear();
      const currMonth = currentMonthDate.getMonth() + 1;
      const todos = works.filter(w => !w.date && !!w.due);
      const monthTodos = todos.filter(w => {
        const [y, m] = w.due.split('-').map(Number);
        return y === currYear && m === currMonth;
      });

      if (!monthTodos.length) {
        todoList.innerHTML = '<div style="font-size:12px;color:var(--text-sub);">æœ¬æœˆæš‚æ— å¾…åŠæ’å•ã€‚</div>';
      } else {
        const sorted = [...monthTodos].sort((a, b) => (a.due || '').localeCompare(b.due || ''));
        sorted.forEach(w => {
          const div = document.createElement('div');
          div.className = 'todo-item';
          div.innerHTML = `
            <span>${w.due.slice(5)} Â· ${w.autoName || w.attr}</span>
            <span style="color:var(--danger);font-size:11px;">æœªå®šç¨¿</span>
          `;
          div.onclick = () => openDetail(w.id);
          todoList.appendChild(div);
        });
      }
    }

    function changeMonth(delta) {
      ensureCurrentMonth();
      const y = currentMonthDate.getFullYear();
      const m = currentMonthDate.getMonth();
      currentMonthDate = new Date(y, m + delta, 1);
      renderCalendar();
    }

    // ========= è¯¦æƒ…å¼¹çª— =========
    function openDetail(id) {
      const w = db.works.find(x => x.id === id);
      if (!w) return;
      detailCurrentId = id;

      document.getElementById('detailTitle').textContent = (w.autoName || w.attr) + ' Â· ' + (w.client || 'æœªçŸ¥');

      const tags = document.getElementById('detailTags');
      tags.innerHTML = '';
      const tagType = document.createElement('span');
      tagType.className = 'badge';
      tagType.textContent = w.type === 'set' ? 'Set ç»„åˆ' : 'å•å“';
      tags.appendChild(tagType);

      const tagUsage = document.createElement('span');
      tagUsage.className = 'badge';
      tagUsage.textContent = 'ä½¿ç”¨æƒï¼š' + (w.usage || 'è‡ªç”¨');
      tags.appendChild(tagUsage);

      const tagVis = document.createElement('span');
      tagVis.className = 'badge';
      tagVis.textContent = 'å…¬å¼€æ€§ï¼š' + (w.visibility || 'å…¬å¼€');
      tags.appendChild(tagVis);

      const imgsWrap = document.getElementById('detailImages');
      imgsWrap.innerHTML = '';
      if (w.images && w.images.length) {
        w.images.forEach(src => {
          const img = document.createElement('img');
          img.src = src;
          img.style.cursor = 'pointer';
          img.onclick = () => window.open(src, '_blank');
          imgsWrap.appendChild(img);
        });
      } else {
        imgsWrap.innerHTML = '<div style="font-size:12px;color:var(--text-sub);">æš‚æ— ä½œå“å›¾ã€‚</div>';
      }

      const fbWrap = document.getElementById('detailFeedbackImgs');
      const fbEmpty = document.getElementById('detailFeedbackEmpty');
      fbWrap.innerHTML = '';
      const fbList = w.feedback || [];
      if (!fbList.length) {
        fbEmpty.style.display = 'block';
      } else {
        fbEmpty.style.display = 'none';
        fbList.forEach(f => {
          const img = document.createElement('img');
          img.src = f.src;
          img.style.cursor = 'pointer';
          img.onclick = () => window.open(f.src, '_blank');
          fbWrap.appendChild(img);
        });
      }

      const detailClient = document.getElementById('detailClient');
      detailClient.innerHTML = `<div style="margin-bottom:4px;">å®¢æˆ·ï¼š<strong>${w.client || 'æœªçŸ¥'}</strong></div>`;

      const detailDates = document.getElementById('detailDates');
      let dateHtml = '';
      if (w.date && !w.due) {
        dateHtml = `å®šç¨¿æ—¥æœŸï¼š${w.date}ï¼ˆå·²å®Œæˆï¼‰`;
      } else if (!w.date && w.due) {
        dateHtml = `æˆªæ­¢æ—¥æœŸï¼š${w.due}ï¼ˆæ’å•ä¸­ï¼‰`;
      } else if (w.date && w.due) {
        dateHtml = `å®šç¨¿ï¼š${w.date} Â· æˆªæ­¢ï¼š${w.due}`;
      }
      detailDates.innerHTML = `<div style="margin-bottom:4px;">${dateHtml || 'æ—¥æœŸä¿¡æ¯ç¼ºå¤±'}</div>`;

      const detailMoney = document.getElementById('detailMoney');
      let moneyHtml = `åŸä»·åˆè®¡ï¼š${money(w.raw || 0)}<br>æŠ˜æ‰£ï¼š${w.discount || 0}ï¼ˆ0=æ— å¿ï¼‰<br>å®æ”¶é‡‘é¢ï¼š${money(w.amount || 0)}`;
      if (!w.date) {
        moneyHtml += '<br><span style="font-size:11px;color:var(--text-sub);">å½“å‰ä¸ºæ’å•ï¼Œç»Ÿè®¡ä¸­ä¸è®¡å…¥æ”¶å…¥ã€‚</span>';
      }
      detailMoney.innerHTML = `<div style="margin-bottom:4px;">${moneyHtml}</div>`;

      const detailItems = document.getElementById('detailItems');
      const items = w.items || [];
      if (!items.length) {
        detailItems.innerHTML = '<div style="margin-bottom:4px;">åˆ¶å“ï¼šæš‚æ— æ˜ç»†ã€‚</div>';
      } else {
        const lines = items.map(it => `${it.name}ï¼ˆ${it.subtype}ï¼Œ${money(it.price || 0)}ï¼‰`);
        detailItems.innerHTML = `<div style="margin-bottom:4px;">åˆ¶å“æ˜ç»†ï¼š<br>${lines.join('<br>')}</div>`;
      }

      const detailRemark = document.getElementById('detailRemark');
      if (w.remark) {
        detailRemark.style.display = 'block';
        detailRemark.textContent = 'å¤‡æ³¨ï¼š' + w.remark;
      } else {
        detailRemark.style.display = 'none';
      }

      openModal('detailModal');
    }

    function startEditFromDetail() {
      if (detailCurrentId == null) return;
      const w = db.works.find(x => x.id === detailCurrentId);
      if (!w) return;
      editingWorkId = w.id;

      // åˆ‡åˆ° Tab1
      switchTab('upload');

      document.getElementById('workAttr').value = w.attr || '';
      document.getElementById('workClient').value = w.client || '';
      document.getElementById('workUsage').value = w.usage || 'è‡ªç”¨';
      document.getElementById('workVisibility').value = w.visibility || 'å…¬å¼€';
      document.getElementById('workRaw').value = (w.raw != null) ? w.raw : '';
      document.getElementById('workDiscount').value = (w.discount != null) ? w.discount : '1';
      document.getElementById('workAmount').value = (w.amount != null) ? w.amount : '';
      document.getElementById('workDate').value = w.date || '';
      document.getElementById('workDue').value = w.due || '';
      document.getElementById('workRemark').value = w.remark || '';
      document.getElementById('chkOverview').checked = w.hasOverview || false;
      // æ¨¡å¼
      const typeBtns = document.querySelectorAll('#typeSwitch button');
      typeBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === w.type);
      });

      // ... å‰é¢çš„ä»£ç ä¸å˜ ...

      initSetRowsForType(w.type || 'single');
      const wrap = document.getElementById('setRows');
      wrap.innerHTML = '';
      
      (w.items || []).forEach(it => {
        // ä¼ å…¥ä¿å­˜çš„ rate å’Œ customRateï¼Œå…¼å®¹æ—§æ•°æ®(æ²¡æœ‰åˆ™é»˜è®¤'1'å’Œ'')
        addSetRow(it.name, it.subtype, it.price, it.rate || '1', it.customRate || '');
      });
      
      // ä¿è¯è‡³å°‘ä¸€è¡Œ
      if (wrap.children.length === 0) {
        addSetRow();
      }
      
      // ... åé¢çš„ä»£ç ä¸å˜ ...
      
      // æ›´æ–°çŠ¶æ€ï¼ˆéšè—åˆ é™¤æŒ‰é’®ç­‰ï¼‰
      updateAllRowsDeleteState(w.type || 'single');

      workImgBuffer = [...(w.images || [])];
      feedbackImgBuffer = (w.feedback || []).map(f => f.src);
      renderWorkPreview();
      renderFeedbackPreview();

      document.getElementById('editBar').classList.add('show');
      document.getElementById('btnSubmitWork').textContent = 'ä¿å­˜ä¿®æ”¹';

      closeModal('detailModal');
    }

    function deleteFromDetail() {
      if (detailCurrentId == null) return;
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
      const idx = db.works.findIndex(x => x.id === detailCurrentId);
      if (idx !== -1) {
        db.works.splice(idx, 1);
      }
      if (editingWorkId === detailCurrentId) {
        editingWorkId = null;
        document.getElementById('editBar').classList.remove('show');
        document.getElementById('btnSubmitWork').textContent = 'æäº¤ä½œå“æ”¶å…¥';
        clearWorkForm();
      }
      detailCurrentId = null;
      saveData().then(() => {
        renderAll();
        closeModal('detailModal');
      });
    }

    // === è¯·æ›¿æ¢ function renderPriceTable() ===

    function renderPriceTable() {
      const container = document.getElementById('priceTable');
      container.innerHTML = '';

      const header = document.createElement('div');
      header.style.fontSize = '12px';
      header.style.color = 'var(--text-sub)';
      header.style.marginBottom = '4px';
      header.textContent = 'åˆ¶å“å Â· ç±»å‹ Â· é»˜è®¤å•ä»·ï¼ˆå¯æ·»åŠ å¤šè¡Œï¼‰';
      container.appendChild(header);

      // ä¿®æ”¹ç‚¹ï¼šåŒæ ·è¿›è¡Œä¸­æ–‡æ‹¼éŸ³æ’åºï¼Œè¿™æ ·æ¯æ¬¡ç‚¹å¼€ä»·æ ¼è¡¨éƒ½æ˜¯æœ‰åºçš„
      const list = [...(db.priceConfig || [])].sort((a, b) => {
        return (a.name || '').localeCompare(b.name || '', 'zh-CN');
      });

      if (!list.length) {
        addPriceRow('', 'é»˜è®¤å•é¢', '');
      } else {
        list.forEach(p => addPriceRow(p.name, p.subtype, p.price));
      }
    }

    function addPriceRow(name = '', subtype = 'é»˜è®¤å•é¢', price = '') {
      const container = document.getElementById('priceTable');
      const row = document.createElement('div');
      row.className = 'price-row';
      row.innerHTML = `
        <input type="text" class="price-name" placeholder="åˆ¶å“å" style="flex:1 1 0;min-width:120px;">
        <select class="price-subtype" style="width:120px;">
          <option value="é»˜è®¤å•é¢">é»˜è®¤å•é¢</option>
          <option value="é»˜è®¤åŒé¢">é»˜è®¤åŒé¢</option>
          <option value="å•é¢">å•é¢</option>
          <option value="åŒé¢">åŒé¢</option>
          <option value="ä¸‰é¢">ä¸‰é¢</option>
          <option value="å››é¢">å››é¢</option>
          <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
        </select>
        <input type="number" step="0.01" class="price-price" placeholder="å•ä»·" style="width:110px;">
        <button type="button" class="btn-outline btn-sm price-del" style="background:#fee2e2;color:#b91c1c;border:none;">åˆ </button>
      `;
      container.appendChild(row);

      const nameInput = row.querySelector('.price-name');
      const subSelect = row.querySelector('.price-subtype');
      const priceInput = row.querySelector('.price-price');
      const delBtn = row.querySelector('.price-del');

      if (name) nameInput.value = name;
      if (subtype) subSelect.value = subtype;
      if (price !== '') priceInput.value = price;

      delBtn.onclick = () => {
        row.remove();
      };
    }

    function savePriceTableFromUI() {
      const rows = document.querySelectorAll('#priceTable .price-row');
      const cfg = [];
      rows.forEach(row => {
        const name = row.querySelector('.price-name').value.trim();
        const subtype = row.querySelector('.price-subtype').value;
        const price = parseFloat(row.querySelector('.price-price').value || '0');
        if (!name) return;
        cfg.push({ name, subtype, price });
      });
      db.priceConfig = cfg;
      updateTypeDatalist();
      saveData().then(() => {
        alert('âœ… ä»·æ ¼è¡¨å·²æ›´æ–°');
        closeModal('priceModal');
      });
    }

    // === è¯·æ›¿æ¢ function updateTypeDatalist() ===

    function updateTypeDatalist() {
      const dl = document.getElementById('typeList');
      dl.innerHTML = '';
      const names = new Set();

      // ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ localeCompare('zh-CN') è¿›è¡Œä¸­æ–‡æ‹¼éŸ³æ’åº
      // [...(...)] æ˜¯ä¸ºäº†å¤åˆ¶ä¸€ä»½æ•°ç»„ï¼Œé˜²æ­¢ç›´æ¥ä¿®æ”¹åŸæ•°æ®é¡ºåº
      const sortedList = [...(db.priceConfig || [])].sort((a, b) => {
        return (a.name || '').localeCompare(b.name || '', 'zh-CN');
      });

      sortedList.forEach(p => {
        if (p.name && !names.has(p.name)) {
          names.add(p.name);
          const opt = document.createElement('option');
          opt.value = p.name;
          dl.appendChild(opt);
        }
      });
    }

    // ========= å¤‡ä»½å¯¼å‡º / å¯¼å…¥ =========
    function exportBackup() {
      const dataStr = JSON.stringify(db);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = getBeijingNow();
      const pad = n => (n < 10 ? '0' + n : '' + n);
      const name = `B1ux-backup-${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}.json`;
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importBackup(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const obj = JSON.parse(e.target.result);
          if (!obj || typeof obj !== 'object') throw new Error('æ ¼å¼é”™è¯¯');
          db.works = obj.works || [];
          db.materials = obj.materials || [];
          db.priceConfig = obj.priceConfig || [];
          saveData().then(() => {
            updateTypeDatalist();
            renderAll();
            alert('âœ… å¯¼å…¥æˆåŠŸ');
          });
        } catch (err) {
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ========= Tabs & Modal =========
    function switchTab(name) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === name);
      });
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === 'tab-' + name);
      });

      if (name === 'calendar') renderCalendar();
      if (name === 'gallery') renderGallery();
      if (name === 'feedback') renderFeedbackWall();
      if (name === 'materials') renderMaterials();
      if (name === 'clients') renderClients();
      if (name === 'analysis') renderAnalysis();
    }

    function openModal(id) {
      const m = document.getElementById(id);
      if (m) m.classList.add('show');
    }

    function closeModal(id) {
      const m = document.getElementById(id);
      if (m) m.classList.remove('show');
    }

    // ========= æ¸²æŸ“å…¥å£ =========
    function renderAll() {
      renderStats();
      renderCalendar();
      renderGallery();
      renderMaterials();
      renderClients();
      renderAnalysis();
      renderFeedbackWall();
      updateClientDatalist();
    }

    function updateClientDatalist() {
      const dl = document.getElementById('clientList');
      dl.innerHTML = '';
      const names = new Set();
      db.works.forEach(w => {
        const c = (w.client || '').trim();
        if (!c || c === 'æœªçŸ¥') return;
        if (!names.has(c)) {
          names.add(c);
          const opt = document.createElement('option');
          opt.value = c;
          dl.appendChild(opt);
        }
      });
      // å¼ºåˆ¶ä¿ç•™ B1ux
      const optB = document.createElement('option');
      optB.value = 'B1ux';
      dl.appendChild(optB);
    }

    // ========= åˆå§‹åŒ– =========
    document.addEventListener('DOMContentLoaded', () => {
      openDB()
        .then(loadData)
        .then(() => {
          // é»˜è®¤æ—¥æœŸ
          const todayStr = formatDate(getBeijingTodayDate());
          const matDate = document.getElementById('matDate');
          if (matDate) matDate.value = todayStr;

          updateTypeDatalist();

          // Set åˆå§‹ä¸€è¡Œ (å•å“æ¨¡å¼)
          initSetRowsForType('single');

          // Tab åˆ‡æ¢
          document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const name = btn.getAttribute('data-tab');
              switchTab(name);
            });
          });

          // ä½œå“æ¨¡å¼åˆ‡æ¢
          document.querySelectorAll('#typeSwitch button').forEach(btn => {
            btn.addEventListener('click', () => {
              document.querySelectorAll('#typeSwitch button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              initSetRowsForType(btn.getAttribute('data-type'));
            });
          });

          // æ·»åŠ  Set å­åˆ¶å“
          document.getElementById('btnAddRow').addEventListener('click', () => {
            addSetRow();
          });

          // ä»·æ ¼è¡¨
          document.getElementById('btnPrice').addEventListener('click', () => {
            renderPriceTable();
            openModal('priceModal');
          });
          document.getElementById('btnAddPriceRow').addEventListener('click', () => {
            addPriceRow();
          });
          document.getElementById('btnSavePrice').addEventListener('click', () => {
            savePriceTableFromUI();
          });

          // å¯¼å‡º / å¯¼å…¥
          document.getElementById('btnExport').addEventListener('click', exportBackup);
          document.getElementById('btnImport').addEventListener('click', () => {
            document.getElementById('fileImport').click();
          });
          document.getElementById('fileImport').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) importBackup(file);
            e.target.value = '';
          });

          // å›¾ç‰‡ä¸Šä¼ 
          document.getElementById('btnPickWorkImg').addEventListener('click', () => {
            document.getElementById('workImagesInput').click();
          });
          document.getElementById('workImagesInput').addEventListener('change', e => {
            handleImageFiles(e.target.files, workImgBuffer, renderWorkPreview, 10);
            e.target.value = '';
          });

          document.getElementById('btnPickFeedbackImg').addEventListener('click', () => {
            document.getElementById('feedbackImagesInput').click();
          });
          document.getElementById('feedbackImagesInput').addEventListener('change', e => {
            handleImageFiles(e.target.files, feedbackImgBuffer, renderFeedbackPreview, 10);
            e.target.value = '';
          });

          // è¡¨å•æäº¤
          document.getElementById('workForm').addEventListener('submit', handleWorkSubmit);
          document.getElementById('matForm').addEventListener('submit', handleMatSubmit);

          // é‡‘é¢è”åŠ¨
          document.getElementById('workDiscount').addEventListener('input', recalcWorkAmountFromRaw);
          document.getElementById('workRaw').addEventListener('input', recalcWorkAmountFromRaw);

          // ç¼–è¾‘çŠ¶æ€å–æ¶ˆ
          document.getElementById('btnCancelEdit').addEventListener('click', () => {
            editingWorkId = null;
            document.getElementById('editBar').classList.remove('show');
            document.getElementById('btnSubmitWork').textContent = 'æäº¤ä½œå“æ”¶å…¥';
            clearWorkForm();
          });

          // æ—¥å†
          document.getElementById('btnPrevMonth').addEventListener('click', () => changeMonth(-1));
          document.getElementById('btnNextMonth').addEventListener('click', () => changeMonth(1));
          document.getElementById('monthInput').addEventListener('change', e => {
            const val = e.target.value;
            if (!val) return;
            const [y, m] = val.split('-').map(Number);
            if (!y || !m) return;
            currentMonthDate = new Date(y, m - 1, 1);
            renderCalendar();
          });

          // Modal å…³é—­æŒ‰é’®
          document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-close');
              if (id) closeModal(id);
            });
          });

          // è¯¦æƒ…é¡µåº•éƒ¨æŒ‰é’®
          document.getElementById('btnEditDetail').addEventListener('click', startEditFromDetail);
          document.getElementById('btnDeleteDetail').addEventListener('click', deleteFromDetail);

          // æ’åº select
          document.getElementById('selSortWorks').addEventListener('change', renderGallery);
          document.getElementById('selSortMat').addEventListener('change', renderMaterials);
          document.getElementById('selClientSort').addEventListener('change', renderClients);

          // åˆå§‹æ¸²æŸ“
          renderAll();
        });
    });
  </script>
</body>
</html>